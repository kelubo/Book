<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="zh-CN">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h2 id="A6d5f00f8-7035-4282-bb05-0804ad2427e2" class="calibre13">Chapter 14<br class="calibre8"/> 第十四章 树莓派机器视觉</h2> 
 <p class="calibre3">树莓派系统是一个卡片式的计算机，对机器视觉能提供很好的支持，基于树莓派的机器视觉系统有着广泛的应用。</p> 
 <h3 id="Acd3f9d66-8930-4c02-8c84-2fa6cfa30ee8" class="calibre14">14.1 安装SimpleCV</h3> 
 <p class="calibre3">SimpleCV是机器人视觉软件OpenCV的Python封装，官方主页网址为：http://simplecv.org/。如果想了解OpenCV，请浏览其主页：https：//opencv.org/。</p> 
 <p class="calibre3">首先需要安装SimpleCV，官网提供了两种方法。</p> 
 <p class="calibre3">（1）在github下载Simplecv源码并且进行安装。命令为：sudo pip install https：//github.com/sightmachine/SimpleCV/zipball/master。</p> 
 <p class="calibre3">（2）在源码中直接安装。首先在home中新建一个新文件夹，再从github把源码克隆到本地。</p> 
 <p class="calibre3">由于SimpleCV仅仅是OpenCV的一个封装包，因此安装SimpleCV需要先安装OpenCV及OpenCV依赖的NumPy等组件。具体包含下面这些组件：</p> 
 <p class="calibre3">（1）Python 2.6+（http://www.python.org）。</p> 
 <p class="calibre3">（2）SciPy（http://www.scipy.org）。</p> 
 <p class="calibre3">（3）NumPy（http://numpy.scipy.org）。</p> 
 <p class="calibre3">（4）Pygame（http://www.pygame.org）。</p> 
 <p class="calibre3">（5）OpenCV 2.3+（http://opencv.org）。</p> 
 <p class="calibre3">（6）IPython 10+（http://ipython.org）。</p> 
 <p class="calibre3">（7）PIL 1.1.7+（http://www.pythonware.com/products/pil/）。</p> 
 <p class="calibre3">下面介绍第一种方法。</p> 
 <p class="calibre3">安装SimpleCV的命令如下：</p> 
 <p class="calibre3">（1）sudo apt-get update。</p> 
 <p class="calibre3">（2）$sudo apt-get install ipython python-opencv python-scipy，如图14-1所示。</p> 
 <div class="center"> 
  <img alt="" class="u575" src="../Images/250_01.jpg" width="1201" height="660"/> 
  <p class="imgtitle">图14-1 安装OpenCV</p> 
 </div> 
 <p class="calibre3">（3）sudo apt-get install python-numpy python-pygame python-setuptools python-pip，如图14-2所示。</p> 
 <div class="center"> 
  <img alt="" class="u576" src="../Images/250_02.jpg" width="1198" height="423"/> 
  <p class="imgtitle">图14-2 安装设置工具</p> 
 </div> 
 <p class="calibre3">（4）sudo pip install svgwrite，如图14-3所示。</p> 
 <div class="center"> 
  <img alt="" class="u577" src="../Images/250_03.jpg" width="1188" height="407"/> 
  <p class="imgtitle">图14-3 安装svgwrite</p> 
 </div> 
 <p class="calibre3">（5）然后通过pip命令下载并安装SimpleCV：$sudo pip installhttps：//github.com/sightmachine/SimpleCV/zipball/master，如图14-4所示。</p> 
 <p class="calibre3">这样SimpleCV就安装完成了。在终端中输入Simplecv即可进入SimpleCV shell，如图14-5所示。</p> 
 <div class="center"> 
  <img alt="" class="u578" src="../Images/251_01.jpg" width="1033" height="472"/> 
  <p class="imgtitle">图14-4 安装SimpleCV</p> 
 </div> 
 <div class="center"> 
  <img alt="" class="u579" src="../Images/251_02.jpg" width="965" height="631"/> 
  <p class="imgtitle">图14-5 SimpleCV启动</p> 
 </div> 
 <h3 id="Aea211258-38ae-48d0-bed0-d534d07e6942" class="calibre14">14.2 SimpleCV使用USB摄像头</h3> 
 <p class="calibre3">通过SimpleCV可以测试自己的USB摄像头，启动SimpleCV，然后输入下列命令：c=Camera()；i=c.getImage()；i.show()；如图14-6所示。</p> 
 <div class="center"> 
  <img alt="" class="u580" src="../Images/251_03.jpg" width="1280" height="566"/> 
  <p class="imgtitle">图14-6 SimpleCV测试USB摄像头</p> 
 </div> 
 <p class="calibre3"><b class="calibre6">注意</b>：在执行c=Camera()时可能出现错误：-bash：lsof：not found，lsof（list open files）是一个列出当前系统打开文件的工具。解决方法，运行命令：sudo apt-get install lsof。</p> 
 <h3 id="A5dd7cb99-21db-4124-b692-30238a4ef17d" class="calibre14">14.3 在SimpleCV中使用Pi Camera</h3> 
 <p class="calibre3">USB摄像头固然方便，但在SimpleCV中，其图像采集效率不如树莓自带的CSI接口。因此使用树莓官方的Pi Camera模块是一个不错的选择。</p> 
 <p class="calibre3">Pi Camera特立独行地使用其专有的驱动，与USB的UVC并不兼容。因此，SimpleCV并不能直接识别Pi Camera。解决方案是为Pi Camera安装第三方的UV4L兼容驱动。</p> 
 <p class="calibre3"><b class="calibre6">注意</b>：下面命令中的uv4l是UV4L的小写。</p> 
 <p class="calibre3">在终端中输入下面的命令（注意后面有个横杠）：$ curl http://www.linux-projects.org/listing/uv4l_ repo/lrkey.asc|sudo apt-key add-，如图14-7所示。</p> 
 <div class="center"> 
  <img alt="" class="u581" src="../Images/252_01.jpg" width="1280" height="341"/> 
  <p class="imgtitle">图14-7 安装Pi Camera第三方UV4L兼容驱动</p> 
 </div> 
 <p class="calibre3">然后修改apt-get的源列表文件/etc/apt/sources.list，以便获取驱动软件包。在文件末尾添加如下内容：deb http://www.linux-projects.org/listing/uv4l_ repo/raspbian/ wheezy main，如图14-8所示。</p> 
 <div class="center"> 
  <img alt="" class="u582" src="../Images/252_02.jpg" width="1280" height="229"/> 
  <p class="imgtitle">图14-8 修改文件/etc/apt/sources.list</p> 
 </div> 
 <p class="calibre3">更新树莓派的固件和apt-get，再通过apt-get安装驱动软件，命令为：$ sudo rpi-update，如图14-9所示，固件更新时，固件网址为：http://mirrordirector.raspbian.org/raspbian/。</p> 
 <p class="calibre3">更新apt-get的命令为：$ sudo apt-get update。</p> 
 <p class="calibre3">通过apt-get安装驱动软件的命令为：$ sudo apt-get install uv4l uv4l-raspicam uv4l-raspi-cam-extras，如图14-10所示。</p> 
 <p class="calibre3">安装完成后重启Pi Camera驱动，就可以使用了。在/dev目录下会生成video0设备文件，这就是Pi Camera摄像头（若树莓派还连接了其他摄像头，video文件的编号可能会发生变化），如图14-11所示。</p> 
 <div class="center"> 
  <img alt="" class="u583" src="../Images/253_01.jpg" width="1220" height="671"/> 
  <p class="imgtitle">图14-9 固件更新</p> 
 </div> 
 <div class="center"> 
  <img alt="" class="u584" src="../Images/253_02.jpg" width="1197" height="787"/> 
  <p class="imgtitle">图14-10 安装驱动软件</p> 
 </div> 
 <div class="center"> 
  <img alt="" class="u585" src="../Images/253_03.jpg" width="1193" height="862"/> 
  <p class="imgtitle">图14-11 /dev目录下会生成video0设备文件</p> 
 </div> 
 <p class="calibre3">输入命令：$ sudo service uv4l raspicam restart，重新启动服务，如图14-12所示。</p> 
 <div class="center"> 
  <img alt="" class="u586" src="../Images/254_01.jpg" width="1088" height="278"/> 
  <p class="imgtitle">图14-12 重新启动服务</p> 
 </div> 
 <p class="calibre3">由于默认开启了preview模式，这时候使用SimpleCV打开摄像头，除了SimpleCV的窗口外，还会有一个摄像头窗口占据屏幕。因此还要修改UV4L配置文件/etc/uv4l/uv4l-raspicam.conf，找到如下内容，去掉前面的“#”注释符关闭预览模式：nopreview=yes，如图14-13所示。</p> 
 <div class="center"> 
  <img alt="" class="u587" src="../Images/254_02.jpg" width="1276" height="842"/> 
  <p class="imgtitle">图14-13 修改配置文件</p> 
 </div> 
 <p class="calibre3">安装了UV4L驱动后的Pi Camera和一般的USB摄像头使用方法完全相同。</p> 
 <p class="calibre3">通过SimpleCV测试Pi Camera摄像头时，启动SimpleCV，然后输入下列命令：c=Camera()；i=c.getImage()；i.show()；如图14-14所示。</p> 
 <div class="center"> 
  <img alt="" class="u588" src="../Images/254_03.jpg" width="1280" height="508"/> 
  <p class="imgtitle">图14-14 测试Pi Camera摄像头</p> 
 </div> 
 <h3 id="A3f5bdf1b-64af-43d9-b4b2-638a45628d3e" class="calibre14">14.4 数硬币</h3> 
 <p class="calibre3">利用树莓派摄像头拍摄图像，图像中包含硬币，计算图像中硬币的数目。</p> 
 <p class="calibre3">SimpleCV是一个开源框架，用于在Python中方便快速地构建计算机视觉方面的应用程序。SimpleCV封装了若干强大的计算机视觉库（目前仅封装了OpenCV），简化了用户对这些库的使用难度，如无须了解位深、文件格式、颜色空间、缓冲区管理等内容，降低了学习成本。可以用于在Python中快速开发计算机视觉的原型程序。利用SimpleCV的findCircle()函数，可以实时计算放到摄像头下面的硬币的数目。</p> 
 <p class="calibre3">在树莓派打开终端，输入命令：simplecv，启动SimpleCV，输入下列代码：</p> 
 <div class="center">
  <img alt="" class="u589" src="../Images/255_01.jpg" width="1280" height="266"/>
 </div> 
 <p class="calibre3">硬币检测使用SimpleCV的findCircle（canny=100，thresh=70，distance=15）方法，用途为边缘检测，包含3个参数：canny——边缘检测的阈值，thresh——确定边缘所需长度，distance——圆形之间的距离。</p> 
 <p class="calibre3">（1）canny：边缘检测的阈值。边缘就是图像像素颜色发生重大变化处的分割线。这个参数的默认值为100，并且降低这个值的时候，会检测到更多的边缘。当然，这不会导致检测到更多的圆形。</p> 
 <p class="calibre3">（2）thresh：找到边缘以后，当减小这个值的时候，会检测到更多的圆形。</p> 
 <p class="calibre3">（3）distance：表示相邻圆形之间的间隔距离（以像素为单位）。</p> 
 <p class="calibre3">在识别的过程中需要对这3个参数进行调整，防止误识别。</p> 
 <p class="calibre3">实验场景如图14-15所示。</p> 
 <div class="center"> 
  <img alt="" class="u590" src="../Images/255_02.jpg" width="675" height="817"/> 
  <p class="imgtitle">图14-15 实验场景</p> 
 </div> 
 <p class="calibre3">运行结果如图14-16所示。</p> 
 <div class="center"> 
  <img alt="" class="u591" src="../Images/256_01.jpg" width="1132" height="739"/> 
  <p class="imgtitle">图14-16 数硬币运行结果</p> 
 </div> 
 <h3 id="Ad0ed5884-dbd1-4300-b68d-6067cb78c733" class="calibre14">14.5 人脸检测</h3> 
 <p class="calibre3">可以使用SimpleCV中的Haar-like特征检测功能分析图像，并识别其中的人脸。在树莓派打开终端，输入命令：Simplecv，启动SimpleCV，输入下列代码：</p> 
 <div class="center">
  <img alt="" class="u592" src="../Images/256_02.jpg" width="1280" height="170"/>
 </div> 
 <p class="calibre3">如图14-17所示。</p> 
 <div class="center"> 
  <img alt="" class="u593" src="../Images/256_03.jpg" width="1280" height="481"/> 
  <p class="imgtitle">图14-17 代码示例</p> 
 </div> 
 <p class="calibre3">Image（“faces.jpg”）用于载入图像。方法findHaarFeatures有一个强制性的文件，它描述待搜索的特征的类型，这些特征被称作haar特征，并且由一个XML文件给出具体的描述，方法findHaarFeatures的第二个参数（min_neighbores）的作用是调节haar函数，随着min_neighbores数值的降低，假阳性的检测结果就会随之增多。</p> 
 <p class="calibre3">这样就会打开一个图像浏览窗口，其中人脸已经用矩形进行了标注，如图14-18所示。</p> 
 <div class="center"> 
  <img alt="" class="u594" src="../Images/257_01.jpg" width="1280" height="893"/> 
  <p class="imgtitle">图14-18 检测人脸</p> 
 </div> 
 <p class="calibre3">可以通过下列命令列出内置的haar特征，如图14-19所示。</p> 
 <div class="center"> 
  <img alt="" class="u595" src="../Images/257_02.jpg" width="1280" height="481"/> 
  <p class="imgtitle">图14-19 内置的haar特征</p> 
 </div> 
 <h3 id="Ad7949e0d-6d37-4f6a-8357-5dc5f3be3f9f" class="calibre14">14.6 动态图像采集</h3> 
 <p class="calibre3">对于动态图像的采集，只需要通过逐帧捕获图像，并连续地显示在屏幕上即可。</p> 
 <p class="calibre3">启动树莓派，打开Python 3的IDLE窗口，新建文件，输入下列代码，并将文件保存为Dynamic_Image_Acquisition.py：</p> 
 <div class="center">
  <img alt="" class="u596" src="../Images/257_03.jpg" width="1280" height="182"/>
 </div> 
 <div class="center">
  <img alt="" class="u597" src="../Images/258_01.jpg" width="1280" height="129"/>
 </div> 
 <p class="calibre3">代码中的Display模块会以窗口的形式显示，其大小通过resolution属性设定。将图片通过save()函数保存至display就会显示在窗口中。display.isNotDone()用来检测窗口是否被关闭，如果不关闭窗口程序，将循环采集和显示摄像头图像。</p> 
 <p class="calibre3">运行结果如图14-20所示。</p> 
 <div class="center"> 
  <img alt="" class="u598" src="../Images/258_02.jpg" width="1280" height="816"/> 
  <p class="imgtitle">图14-20 动态图像采集运行结果</p> 
 </div> 
 <h3 id="A874675a1-e057-4176-8a28-4ea9889e8001" class="calibre14">14.7 运动检测</h3> 
 <p class="calibre3">可以使用SimpleCV来检测源自摄像头的连续帧之间的变化情况。基本原理是将捕获到的图像与之前的图像比较，然后，检查插值图像中的所有斑块（颜色相近的区域），如果找到大于MIN_BLOB_SIZE的，就打印输入一条信息，检测到移动现象。</p> 
 <p class="calibre3">启动树莓派，打开Python 3的IDLE窗口，新建文件，输入下列代码，并将文件保存为Motion_Detection.py：</p> 
 <div class="center">
  <img alt="" class="u493" src="../Images/258_03.jpg" width="1280" height="357"/>
 </div> 
 <div class="center">
  <img alt="" class="u599" src="../Images/259_01.jpg" width="1280" height="139"/>
 </div> 
 <p class="calibre3">运行结果如图14-21所示。</p> 
 <div class="center"> 
  <img alt="" class="u600" src="../Images/259_02.jpg" width="1280" height="461"/> 
  <p class="imgtitle">图14-21 运动检测结果</p> 
 </div> 
 <h3 id="A9e7e0826-4746-4f86-ac3f-7bb0eb9d6779" class="calibre14">14.8 本章小结</h3> 
 <p class="calibre3">机器人视觉是机器人的重要组成部分，在机器人上有着广泛的应用。本章介绍了树莓派的机器人视觉库SimpleCV。SimpleCV是机器人视觉软件OpenCV的Python封装。同时，还介绍了SimpleCV在视觉的一些应用，包括数硬币、人脸检测、动态图像采集、运动检测等，给出了应用示例及实现方法。</p> 
</body>
</html>
