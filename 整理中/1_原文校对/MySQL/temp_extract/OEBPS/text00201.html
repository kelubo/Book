<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" style="font-size:1.250rem;">
<head><title></title>
<link href="flow0001.css" rel="stylesheet" type="text/css" />
</head>
<body>
<h3 class="p3">13.5.5　InnoDB优化器统计信息配置</h3>
<p class="ziti">InnoDB表的优化器统计信息分为永久和非永久两种。</p>
<p class="ziti">对于永久的优化器统计信息，即使是服务器重启的情况下也会存在，其用于选出更优的执行计划以便提供更好的查询性能。</p>
<p class="ziti">配置innodb_stats_auto_recalc参数可用来控制统计信息在表发生了巨大变化（超过10%的行）之后是否自动更新，但是由于自动更新统计信息本身是异步的，所以有时未必能马上更新，这时可以执行analysis table语句来同步更新统计信息。</p>
<p class="ziti">create table和alter table语句中的stats_persistent、stats_auto_recalc、stats_sample_pages子句可用来配置单个表的优化器统计信息规则，具体如下。</p>
<p class="ziti">1）stats_persistent用来指定是否对此表开启永久统计资料，1代表开启，0代表不开启。当开启之后，可以执行analyze table命令收集统计资料。</p>
<p class="ziti">2）stats_auto_recalc表示是否对表的永久统计资料自动进行重新计算，默认值与全局参数innodb_stats_auto_recalc一致。1代表当表中10%以上的数据更新时需要重新计算，0代表不自动更新，而是通过analyze table命令重新计算。</p>
<p class="ziti">3）stats_sample_pages表示计算索引列的统计资料是需要的索引页的样本数量。</p>
<p class="ziti">代码如下：</p>
<hr/>
<pre class="ziti1">CREATE TABLE `t1` (
`id` int(8) NOT NULL auto_increment,
`data` varchar(255),
`date` datetime,
PRIMARY KEY  (`id`),
INDEX `DATE_IX` (`date`)
) ENGINE=InnoDB,
  STATS_PERSISTENT=1,
  STATS_AUTO_RECALC=1,
STATS_SAMPLE_PAGES=25;</pre>
<hr/>
<p class="ziti">优化器统计资料数据存储在系统表mysql.innodb_table_stats和mysql.innodb_index_stats表中，这两个表中有一个字段last_update可以用来判断统计信息最后更改的时间。这两个表的数据也可以通过手工更改。当手工更改完数据之后，要执行“flush table表名”命令来重新load此表的统计资料。innodb_table_stats表中的每个目标表示一行记录，而innodb_index_stats表中的每个索引都会有多条记录。</p>
<p class="ziti">Innodb_table_stats表结构如表13-2所示。</p>
<p class="middle-img">表13-2　Innodb_table_stats表结构</p>
<div class="pic"><img alt="" src="Image00102.jpg" />
</div>
<div class="pic"><img alt="" src="Image00103.jpg" />
</div>
<p class="ziti">Innodb_table_stats表结构代码如下：</p>
<hr/>
<pre class="ziti1">mysql&gt; select * from mysql.innodb_table_stats where table_name='students'\G
*************************** 1. row ***************************
           database_name: test
              table_name: students
             last_update: 2017-04-21 17:12:07
                  n_rows: 5
    clustered_index_size: 1
sum_of_other_index_sizes: 2</pre>
<hr/>
<p class="ziti">Innodb_index_stats表结构如表13-3所示。</p>
<p class="middle-img">表13-3　Innodb_index_stats表结构</p>
<div class="pic"><img alt="" src="Image00104.jpg" />
</div>
<p class="ziti">Innodb_index_stats表结构代码如下：</p>
<hr/>
<pre class="ziti1">mysql&gt; select * from mysql.innodb_index_stats where table_name='students';
+---------------+------------+--------------+---------------------+--------------+
| database_name | table_name | index_name   | last_update         | stat_name    | stat_value | sample_size | stat_description                  |
+---------------+------------+--------------+---------------------+--------------+
| test          | students   | PRIMARY      | 2017-04-21 17:12:07 | n_diff_pfx01 |          5 |           1 | sid                               |
| test          | students   | PRIMARY      | 2017-04-21 17:12:07 | n_leaf_pages |          1 |        NULL | Number of leaf pages in the index |
| test          | students   | PRIMARY      | 2017-04-21 17:12:07 | size         |          1 |        NULL | Number of pages in the index      |
| test          | students   | idx_st_sid   | 2017-04-21 17:12:07 | n_diff_pfx01 |          5 |           1 | sid                               |
| test          | students   | idx_st_sid   | 2017-04-21 17:12:07 | n_leaf_pages |          1 |        NULL | Number of leaf pages in the index |
| test          | students   | idx_st_sid   | 2017-04-21 17:12:07 | size         |          1 |        NULL | Number of pages in the index      |</pre>
<hr/>
<p class="ziti">“Stat_name=n_diff_pfxNN”参数：当参数是n_diff_pfx01时，stat_value列表示索引第一列上的区别值有几个；当参数是n_diff_pfx02时，stat_value列表示索引第一、二列上的区别值有几个，以此类推。而stat_description列显示了对应的逗号隔开的索引列值。</p>
<p class="ziti">默认情况下，永久优化器统计信息的属性是开启的，即innodb_stats_persistent=ON。</p>
<p class="ziti">非永久优化器统计信息会在每次进行服务器重启或者其他一些操作时被清理。</p>
<p class="ziti">设置“innodb_stats_persistent=ON”参数（默认），可将优化器统计信息存储在磁盘上。</p>
<p class="ziti">MySQL的查询优化器会基于评估好的统计资料选择合适的索引参与到执行计划中，而类似于analyze table的语句则会从索引中随机选取数据页参与到每个索引的基数评估中。而参数innodb_stats_persistent_sample_pages则决定了参与评估的数据页的数量，默认值是20。当语句执行的执行计划不是最优选择时，可考虑增加此参数，以便获得正确的统计资料。</p>
<p class="ziti">当设置参数innodb_stats_persistent=OFF或者对单个表设置stats_persistent=0时，对应的统计资料就仅存在于内存中而非磁盘上，当服务器重启之后统计资料丢失，代码如下：</p>
<hr/>
<pre class="ziti1">mysql&gt; alter table students stats_persistent=0;
Query OK, 0 rows affected (0.00 sec)
Records: 0  Duplicates: 0  Warnings: 0
mysql&gt; truncate table students;
mysql&gt; analyze table students;
+-----------------+---------+----------+----------+
| Table           | Op      | Msg_type | Msg_text |
+-----------------+---------+----------+----------+
| course.students | analyze | status   | OK       |
mysql&gt; select * from mysql.innodb_index_stats where table_name=‘students';
##最新统计信息在表中不更新
+---------------+------------+------------+---------------------+--------------+
| database_name | table_name | index_name | last_update         | stat_name    | stat_value | sample_size | stat_description
+---------------+------------+------------+---------------------+--------------+
| course        | students   | PRIMARY    | 2017-05-18 09:14:21 | n_diff_pfx01 |      97344 |          20 | sid                               |
| course        | students   | PRIMARY    | 2017-05-18 09:14:21 | n_leaf_pages |        234 |        NULL | Number of leaf pages in the index |
| course        | students   | PRIMARY    | 2017-05-18 09:14:21 | size         |        289 |        NULL | Number of pages in the index      |
| course        | students   | idx_1      | 2017-05-18 09:15:30 | n_diff_pfx01 |          0 |           2 | gender                            |
| course        | students   | idx_1      | 2017-05-18 09:15:30 | n_diff_pfx02 |     100710 |          20 | gender,sid                        |
| course        | students   | idx_1      | 2017-05-18 09:15:30 | n_leaf_pages |         90 |        NULL | Number of leaf pages in the index |
| course        | students   | idx_1      | 2017-05-18 09:15:30 | size         |        161 |        NULL | Number of pages in the index

mysql&gt; alter table students stats_persistent=1;
mysql&gt; analyze table students;
+-----------------+---------+----------+----------+
| Table           | Op      | Msg_type | Msg_text |
+-----------------+---------+----------+----------+
| course.students | analyze | status   | OK       |
+-----------------+---------+----------+----------+
1 row in set (0.01 sec)
mysql&gt; select * from mysql.innodb_index_stats where table_name='students';
+---------------+------------+------------+---------------------+--------------+
| database_name | table_name | index_name | last_update         | stat_name    | stat_value | sample_size | stat_description                  |
+---------------+------------+------------+---------------------+--------------+
| course        | students   | PRIMARY    | 2017-05-18 09:33:39 | n_diff_pfx01 |          0 |           1 | sid                               |
| course        | students   | PRIMARY    | 2017-05-18 09:33:39 | n_leaf_pages |          1 |        NULL | Number of leaf pages in the index |
| course        | students   | PRIMARY    | 2017-05-18 09:33:39 | size         |          1 |        NULL | Number of pages in the index      |
| course        | students   | idx_1      | 2017-05-18 09:33:39 | n_diff_pfx01 |          0 |           1 | gender                            |
| course        | students   | idx_1      | 2017-05-18 09:33:39 | n_diff_pfx02 |          0 |           1 | gender,sid                        |
| course        | students   | idx_1      | 2017-05-18 09:33:39 | n_leaf_pages |          1 |        NULL | Number of leaf pages in the index |
| course        | students   | idx_1      | 2017-05-18 09:33:39 | size         |          1 |        NULL | Number of pages in the index      |</pre>
<hr/>
<p class="ziti">比如执行analyze table语句手动刷新统计资料，或者在innodb_stats_on_metadata选项打开之后执行show table status/show index，或者查询information_schema.tables/statistics表时，非永久统计资料都会自动更新，当InnoDB检测到1/16的表数据被修改时也会更新。</p>
</body>
</html>
