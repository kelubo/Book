<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" style="font-size:1.250rem;">
<head><title></title>
<link href="flow0001.css" rel="stylesheet" type="text/css" />
</head>
<body>
<h3 class="p3">14.2.2　在主库Master（51）上执行操作配置</h3>
<p class="p6">1.设置server-id的值并开启binlog功能参数</p>
<p class="ziti">根据前文介绍的MySQL主从复制原理我们可以知道，要实现主从复制，关键是要开启binlog日志功能，所以，首先我们需要打开主库的binlog日志参数。</p>
<p class="ziti">1）修改主库的配置文件。执行vi/etc/my.cnf，编辑MySQL的配置文件，两个参数按如下内容进行修改：</p>
<hr/>
<pre class="ziti1">[mysqld]
server_id = 1  #&lt;==用于同步的每台机器或实例server_id都不能相同。
log_bin = /application/mysql/logs/oldboy-bin   #&lt;==红色加粗可省略，本文是与前面
                                               的章节保持一致。
特别提示：从MySQL5.6起，参数中改用"_"代替"-"了，但是常规情况下后面这种写法依然兼容。</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
</p>
<p class="ziti6">·上面的两个参数要放在my.cnf中的[mysqld]模块下，否则会出错。</p>
<p class="ziti6">·server-id的值使用服务器IP地址最后一个小数点后面的数字如19，目的是避免不同的机器或实例ID重复（不适合多实例）。server-id的取值范围为0&lt;server-id&lt;2<sup>32</sup>
 -1的自然数。</p>
<p class="ziti6">·首先要在my.cnf配置文件中查找相关参数，并按要求进行修改。若发现不存在，再添加参数，切记，参数不能重复。</p>
<p class="ziti6">·修改my.cnf配置后需要重启数据库，注意要确认已经真正重启了。</p>
<p class="ziti">2）检查配置参数之后的结果：</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# egrep "server_id|log_bin" /etc/my.cnf
log_bin = /application/mysql/logs/oldboy-bin #&lt;==后面可以不带等号部分，MySQL会
                                             使用默认路径及日志名。
server_id = 1</pre>
<hr/>
<p class="ziti">3）重启主库MySQL服务：</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# /etc/init.d/mysqld restart
Shutting down MySQL.. SUCCESS!
Starting MySQL. SUCCESS!</pre>
<hr/>
<p class="ziti">4）登录数据库检查参数的更改情况：</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# mysql -e "show variables like 'log_bin';" #&lt;==不登入数据库检查，
                                                       密码已写入配置文件。
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_bin       | ON    |  #&lt;==Binlog功能已开启
+---------------+-------+
[root@db01 ~]# mysql -e "show variables like 'server_id';"
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 1     | #&lt;==通过检查可以得知配置的server_id为1
+---------------+-------+
提示：通过使用show variables在数据库里查询变量的方式是真正确认数据库参数是否生效的关键。</pre>
<hr/>
<p class="ziti">到此，主库的binlog功能就开启了。</p>
<p class="p6">2.在主库上建立用于主从复制的账号</p>
<p class="ziti">根据主从复制的原理，从库要想与主库同步，必须要有一个可以连接主库的账号，并且这个账号是在主库上创建的，权限是允许从库连接主库并同步数据。</p>
<p class="ziti">1）登录主数据库（172.16.1.51），命令如下：</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# mysql #&lt;==为了操作安全方便，密码已写入my.cnf配置文件。</pre>
<hr/>
<p class="ziti">2）建立用于从库复制的账号及对应的权限：</p>
<hr/>
<pre class="ziti1">mysql&gt; grant replication slave on *.* to 'rep'@'172.16.1.%' identified by 'oldboy123';
Query OK, 0 rows affected (0.01 sec)
#replication slave为允许MySQL Slave同步的必需权限，此处不要授权all权限。
# “*.*”表示所有库所有表，也可以指定具体的库和表进行复制。例如oldboy.test中，oldboy为库，test为表。
# 'rep'@'172.16.1.%'中的rep为同步账号。172.16.1.%为授权主机网段，使用了“%”表示允许整个172.16.1.0网段以rep用户访问。
# identified by 'oldboy123'中的oldboy123为密码，在实际环境中还是复杂一点为好。
mysql&gt; flush privileges; #&lt;==刷新权限使得授权的权限生效，对账号进行更改一般需要此
                           命令，此处是为养成习惯而执行，而不是必须执行。
Query OK, 0 rows affected (0.02 sec)</pre>
<hr/>
<p class="ziti">3）检查主库创建的rep复制账号：</p>
<hr/>
<pre class="ziti1">mysql&gt; select user,host from mysql.user; #&lt;==检查账号命令。
+------+------------+
| user | host       |
+------+------------+
| root | 127.0.0.1  |
| rep  | 172.16.1.% | #&lt;==出现这一行表示复制账号已经配置好了。
| root | localhost  |
+------+------------+
3 rows in set (0.00 sec)
mysql&gt; show grants for rep@'172.16.1.%'; #&lt;==查看授权权限命令。
+------------------------------------------------------------------------+
| GRANT REPLICATION SLAVE ON *.* TO 'rep'@'172.16.1.%' IDENTIFIED BY PASSWORD '*FE28814B4A8B3309DAC6ED7D3237ADED6DA1E515' | #&lt;==结果显示，rep账号权限正是配置的主
                                          从复制所需要的权限。
REPLICATION SLAVE
+------------------------------------------------------------------------+</pre>
<hr/>
<p class="p6">3.对主数据库锁表只读后进行备份</p>
<p class="ziti">1）对主数据库锁表只读（当前窗口不要关掉）的命令如下：</p>
<hr/>
<pre class="ziti1">mysql&gt; flush table with read lock;
Query OK, 0 rows affected (0.00 sec)</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 对于不同引擎的情况，这个锁表命令的时间会受到下面参数的控制。锁表时，如果超过了设置的时间则会自动解锁。</p>
<p class="ziti">默认情况下，自动解锁的时长参数值设置如下：</p>
<hr/>
<pre class="ziti1">mysql&gt; show variables like '%timeout%';
#&lt;==截取部分关键内容如下
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| interactive_timeout        | 28800 |
| wait_timeout               | 28800 |
+----------------------------+-------+
10 rows in set (0.00 sec)</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 关于这两个参数的具体详情，请读者自行测试。</p>
<p class="ziti">2）锁表后查看主库的状态：</p>
<hr/>
<pre class="ziti1">mysql&gt; show master status;
+-------------------+----------+--------------+------------------+-------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+-------------------+
| oldboy-bin.000023 |      626 |              |                  |                   |
+-------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)</pre>
<hr/>
<p class="ziti">最关键的是前两项，由上述代码可以看到当前binlog日志文件名和二进制binlog日志偏移量的位置。</p>
<p class="ziti">注意，“show master status；”命令显示的信息需要记录在案，将后面的从库导入全备后，继续对主库进行复制时就是要从这个文件以及对应的位置开始（MySQL 5.6版本支持GTID功能，关于此功能，后文会详细讲解）。</p>
<p class="ziti">3）导出主库数据</p>
<p class="ziti">锁表后，一定要单开一个新的SSH窗口（否则锁表会失效），导出数据库中的所有数据，如果数据量很大（30GB以上），并且允许停机，则也可以停库直接打包数据文件进行迁移，那样做速度更快，使用第9章提供的Xtrabackup进行热备份也可以。</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# mkdir /server/backup -p  #&lt;==创建备份目录。
[root@db01 ~]# mysqldump -A -B |gzip &gt;/server/backup/bak_$(date +%F).sql.gz
#&lt;==实施备份导出数据。
[root@db01 ~]# ls -l /server/backup/bak_$(date +%F).sql.gz #&lt;==检查备份。
-rw-r--r--. 1 root root 215482 9月  12 22:12 /server/backup/bak_2017-09-12. sql.gz</pre>
<hr/>
<p class="ziti">为了确保导出数据期间，数据库没有数据插入，导库完毕后可以再检查下主库的状态信息：</p>
<hr/>
<pre class="ziti1">mysql&gt; show master status;
+-------------------+----------+--------------+------------------+-------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+-------------------+
| oldboy-bin.000023 |      626 |              |                  |                   |
+-------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 若无特殊情况，binlog文件及位置点与锁表后导出数据前是一致的，即没有发生变化，如果使用了-F参数导出数据，因为会切割日志文件，因此上述状态可能会发生变化，但是两次状态变化之间并没有数据写入。</p>
<p class="ziti">导出数据完毕后，解锁主库，恢复可写，因为主库还要对外提供服务，因此不能一直锁定不让用户访问：</p>
<hr/>
<pre class="ziti1">mysql&gt; unlock tables;</pre>
<hr/>
<p class="ziti">可能会有读者因为锁表后的binlog位置问题而犯迷糊，实际上在做从库之前，无论主库更新了多少数据，最后从库都可以从上面show master status的位置很快赶上主库的进度。</p>
<p class="p6">4.把从主库导出的MySQL数据迁移到从库</p>
<p class="ziti">这里常用的命令有scp、rsync等，可将备份的数据复制到异地。</p>
<p class="ziti">本文采用scp进行复制，命令如下：</p>
<hr/>
<pre class="ziti1">[root@db01 ~]# scp -rp /server/backup/bak_$(date +%F).sql.gz root@172.16.1.52:/opt
The authenticity of host '172.16.1.52 (172.16.1.52)' can't be established.
RSA key fingerprint is a3:42:ca:c2:e6:a9:cb:0b:9f:aa:8a:23:15:2c:c6:87.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.16.1.52' (RSA) to the list of known hosts.
reverse mapping checking getaddrinfo for bogon [172.16.1.52] failed - POSSIBLE BREAK-IN ATTEMPT!
root@172.16.1.52's password:
bak_2017-09-12.sql.gz                          100%  210KB 210.4KB/s   00:00</pre>
<hr/>
<p class="ziti">若出现如上提示，则表示数据库备份已经复制到172.16.1.52从数据库服务器的/opt目录下了。</p>
</body>
</html>
