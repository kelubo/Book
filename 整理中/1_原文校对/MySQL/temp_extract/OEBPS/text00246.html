<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" style="font-size:1.250rem;">
<head><title></title>
<link href="flow0001.css" rel="stylesheet" type="text/css" />
</head>
<body>
<h3 class="p3">16.2.6　在主库2Master（52）上执行操作配置</h3>
<p class="p6">1.设置主库2上复制的相关参数</p>
<p class="ziti">1）修改主库2的配置文件。执行vi/etc/my.cnf，编辑MySQL的配置文件，两个参数按如下内容进行修改：</p>
<hr/>
<pre class="ziti1">[mysqld]
server_id = 2                 #&lt;==用于同步的每台机器或实例的server_id都不能相同。
log_bin = /application/mysql/logs/oldboy-bin   #&lt;==可省略红色加粗部分，本文是与
                                               前面的章节保持一致。
log_slave_updates                       #&lt;==从库记录Binlog必备参数。
expire_logs_days = 7                    #&lt;==自动清除7天前的binlog日志文件。
auto_increment_increment          = 2   #&lt;==自增ID的间隔,如 1 3 5,间隔为2。
auto_increment_offset             = 2   #&lt;==ID的初始位置。
slave-skip-errors = 1032,1062,1007,1008,1146,1049    #&lt;==忽略一些不影响业务的
                                                   复制错误提示。</pre>
<hr/>
<p class="ziti">2）检查参数配置之后的结果：</p>
<hr/>
<pre class="ziti1">[root@db02 ~]# egrep "server_id|log|auto" /etc/my.cnf
log_bin = /application/mysql/logs/oldboy-bin
expire_logs_days = 7
server_id = 2 #&lt;==这个ID与主库1的ID是不同的。
log_slave_updates
auto_increment_increment    = 2
auto_increment_offset   = 2   #&lt;==该起始数字与主库1也是不同的。
log-error = /application/mysql/logs/oldboy.err
#特别提示：部分参数在前面章节中已经配置过，请注意检查不要重复。</pre>
<hr/>
<p class="ziti">3）重启主库2的MySQL服务，并登录数据库检查参数的生效情况（这里略）。</p>
<hr/>
<pre class="ziti1">[root@db02 ~]# /etc/init.d/mysqld restart
Shutting down MySQL.. SUCCESS!
Starting MySQL. SUCCESS!</pre>
<hr/>
<p class="ziti">到此，主库2的binlog功能和ID起始，以及自增配置就配置好了。</p>
<p class="p6">2.在需要做复制的主库2上导入全备做复制</p>
<p class="ziti">特别提示：主库2上不需要再设置主库1用于复制的账号了，因为备份恢复到数据库，主库2就有了账号了，导入的命令如下：</p>
<hr/>
<pre class="ziti1">zcat /opt/bak1_$(date +%F).sql.gz|mysql
mysql &lt;&lt; EOF
CHANGE MASTER TO
MASTER_HOST='172.16.1.51',
MASTER_PORT=3306,
MASTER_USER='rep',
MASTER_PASSWORD='oldboy123';
EOF
提示：这里忽略了两个参数MASTER_LOG_FILE和MASTER_LOG_POS，这是因为在备份的时候使用了“--master-data=1”，在导入数据库时，这两个参数已经自动设置好了。</pre>
<hr/>
<p class="ziti">这里的CHANGE MASTER后无须指定binlog文件名及其具体位置，因为这部分已经在还原数据时提前应用到数据库里了（备份时“--master-data=1”的功劳）。</p>
<p class="p6">3.启动从库同步开关并测试主主复制</p>
<p class="ziti">1）启动从库主主复制开关，并查看复制状态。相关语句如下：</p>
<hr/>
<pre class="ziti1"> [root@db02 opt]# mysql -e "start slave;"
[root@db02 opt]# mysql -e "show slave status\G;"
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 172.16.1.51
                  Master_User: rep
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: oldboy-bin.000025
          Read_Master_Log_Pos: 120
               Relay_Log_File: db02-relay-bin.000011
                Relay_Log_Pos: 284
        Relay_Master_Log_File: oldboy-bin.000025
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              ...省略若干...
1 row in set (0.00 sec)
提示：有关show slave status结果的详细说明，请大家查看MySQL手册。</pre>
<hr/>
<p class="ziti">主主复制是否配置成功了，其中最关键的是如下所示的3项状态参数：</p>
<hr/>
<pre class="ziti1">[root@db02 opt]# mysql -e "show slave status\G;"|egrep "IO_Running|SQL_Running: |_Behind_Master"
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
        Seconds_Behind_Master: 0</pre>
<hr/>
<p class="ziti">特别强调：在首次开启复制的过程中，如果出现复制错误，可以执行如下语句。</p>
<hr/>
<pre class="ziti1">stop slave; #&lt;==临时停止同步开关。
set global sql_slave_skip_counter = 1; #&lt;==将同步指针向下移动一个，如果多次移动仍
                                        不同步，则可以重复操作。
start slave; #&lt;==开启同步开关。</pre>
<hr/>
<p class="ziti">最后记录下主库2的binlog状态，用于在主库1上进行复制的binlog复制的位置点：</p>
<hr/>
<pre class="ziti1">mysql&gt; show master status;
+-------------------+----------+--------------+------------------+-------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+-------------------+
| oldboy-bin.000027 |  1303324 |              |                  |                   |
+-------------------+----------+--------------+------------------+-------------------+
1 row in set (0.01 sec)</pre>
<hr/>
</body>
</html>
