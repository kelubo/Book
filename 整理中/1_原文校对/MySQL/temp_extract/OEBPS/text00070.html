<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" style="font-size:1.250rem;">
<head><title></title>
<link href="flow0001.css" rel="stylesheet" type="text/css" />
</head>
<body>
<h2 class="p2">4.5　配置及管理MySQL多实例数据库</h2>
<p class="p6">1.配置MySQL多实例数据库开机自启动</p>
<p class="ziti">服务的开机自启动很关键，MySQL多实例的启动也不例外。把MySQL多实例的启动命令加入/etc/rc.local，可实现开机自启动：</p>
<hr/>
<pre class="ziti1">[root@oldboy scripts]# echo "#mysql multi instances" &gt;&gt;/etc/rc.local
[root@oldboy scripts]# echo "/data/3306/mysql start" &gt;&gt;/etc/rc.local
[root@oldboy scripts]# echo "/data/3307/mysql start" &gt;&gt;/etc/rc.local
[root@oldboy scripts]# tail -3 /etc/rc.local
#mysql multi instances
/data/3306/mysql start
/data/3307/mysql start</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 要确保MySQL脚本可执行，当然，也可以调整脚本，然后通过chkconfig进行开机启动管理，这部分内容在《跟老男孩学习Linux运维：Shell编程实战》一书中有深入讲解！</p>
<p class="p6">2.登录MySQL测试</p>
<p class="ziti">测试命令如下：</p>
<hr/>
<pre class="ziti1">[root@oldboy scripts]# mysql -S /data/3306/mysql.sock #&lt;==直接输入就可以进来了，而且身份还是root。但是多了-S /data/3306/mysql.sock，用于区别登录不同的实例。
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.40 Source distribution
Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.
Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
mysql&gt; quit
Bye
[root@oldboy scripts]# mysql -S /data/3307/mysql.sock #&lt;==登录3307实例。
Welcome to the MySQL monitor.  Commands end with ; or \g.
...省略若干...
mysql&gt; quit
Bye</pre>
<hr/>
<p class="p6">3.MySQL多实例数据库的管理方法</p>
<p class="ziti">MySQL安装完成之后，默认情况下，MySQL管理员的账号root是无密码的。登录不同的实例需要指定不同实例的sock路径及mysql.sock文件，这个mysql.sock是在my.cnf配置文件里指定的。</p>
<p class="ziti">下面是无密码情况下登录数据库的方法，关键点是“-S”参数及后面指定的/data/3306/mysql.sock，注意，对于不同实例的sock，虽然它们的名字相同，但是路径是不同的，因此指的是不同的文件：</p>
<hr/>
<pre class="ziti1">mysql -S /data/3306/mysql.sock
mysql -S /data/3307/mysql.sock</pre>
<hr/>
<p class="ziti">下面是重启对应实例数据库的命令：</p>
<hr/>
<pre class="ziti1">/data/3306/mysql stop #&lt;==停止数据库。
/data/3306/mysql start</pre>
<hr/>
<p class="p6">4.MySQL安全配置</p>
<p class="ziti">MySQL管理员的账号root密码默认为空，极不安全，可以通过mysqladmin命令为mysql不同实例的数据库设置独立的密码。示例如下：</p>
<hr/>
<pre class="ziti1">[root@oldboy scripts]# mysqladmin -u root -S /data/3306/mysql.sock password 'oldboy123'
#&lt;==为mysql数据库3306实例root用户设置密码oldboy123。
Warning: Using a password on the command line interface can be insecure.
#&lt;==这里的Warning是5.6版本开始才有的， 是提醒用户不要在命令行输入密码，后文会讲解消除
       的方法。
[root@oldboy scripts]# mysqladmin -u root -S /data/3307/mysql.sock password 'oldboy456'
#&lt;==为mysql数据库3307实例root用户设置密码oldboy456。
Warning: Using a password on the command line interface can be insecure.
[root@oldboy scripts]# mysql -uroot -p -S /data/3306/mysql.sock
#&lt;==无法直接登录了
Enter password:
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)
[root@oldboy scripts]# mysql -uroot -p -S /data/3306/mysql.sock
Enter password:
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)
[root@oldboy scripts]# mysql -uroot -p -S /data/3306/mysql.sock
#&lt;==新的登录方式
Enter password:  #&lt;==输入新密码oldboy123
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.6.40 Source distribution
…省略若干…
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
mysql&gt;</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 3307实例的设置方法和3306实例的设置相同，只是连接时的sock路径不同而已，关于这点已提醒多次，大家要注意下。</p>
<p class="ziti">下面介绍带密码登录不同实例数据库的方法。</p>
<p class="ziti">登录3306实例：</p>
<hr/>
<pre class="ziti1">mysql -uroot -poldboy123 -S /data/3306/mysql.sock</pre>
<hr/>
<p class="ziti">登录3307实例：</p>
<hr/>
<pre class="ziti1">mysql -uroot -poldboy456 -S /data/3307/mysql.sock</pre>
<hr/>
<p class="ziti6"><img alt="" class="formula-1-5em" src="Image00006.jpg" />
 <span class="yanse">提示：</span>
 基础弱的读者，在测试时尽量保证多实例的密码相同，可以减少麻烦，后面还原数据库会覆盖密码，因此这里也会把3306、3307的密码统一设为“oldboy123！”修改命令为：</p>
<hr/>
<pre class="ziti1">mysqladmin -u root -S /data/3307/mysql.sock -poldboy456 password oldboy123</pre>
<hr/>
<p class="ziti">更多内容，如删除默认的test数据库，以及删除默认的多实例的用户，请参见第3章，更多的数据库安全，请参考数据库优化章节。</p>
<p class="p6">5.如何再增加一个MySQL的实例</p>
<p class="ziti">若在已经有了3306和3307实例的基础之上，还想要再增加一个MySQL实例，该怎么办？下面给出增加一个MySQL 3308端口实例的命令集合：</p>
<hr/>
<pre class="ziti1">mkdir -p /data/3308/data
\cp /data/3306/my.cnf  /data/3308/
\cp /data/3306/mysql  /data/3308/
sed -i 's/3306/3308/g' /data/3308/my.cnf
sed -i 's/server-id = 6/server-id = 8/g' /data/3308/my.cnf
sed -i 's/3306/3308/g' /data/3308/mysql
chown -R mysql:mysql /data/3308
chmod 700 /data/3308/mysql
cd /application/mysql/scripts
./mysql_install_db --defaults-file=/data/3308/my.cnf --datadir=/data/3308/data --basedir=/application/mysql --user=mysql
chown -R mysql:mysql /data/3308
egrep "server-id|log-bin" /data/3308/my.cnf
/data/3308/mysql start
sleep 5
netstat -lnt|grep 3308
#提示：最好把server-id按照IP地址最后一个小数点的数字进行设置或者按照实例端口尾数进行设置。
#成功标志：多了一个启动的端口3308
[root@oldboy scripts]# netstat -lnt|grep 330
tcp        0      0 0.0.0.0:3306              0.0.0.0:*             LISTEN
tcp        0      0 0.0.0.0:3307              0.0.0.0:*             LISTEN
tcp        0      0 0.0.0.0:3308              0.0.0.0:*             LISTEN</pre>
<hr/>
<p class="ziti">如果配置完毕，服务启动后却没有运行起来，别忘了一定要看MySQL错误日志，在“/data/3308/my.cnf”最下面有错误日志路径地址。本例作为作业留给读者自己去实践，看看能否独自搞定增加这个实例。</p>
<p class="p6">6.多实例MySQL登录问题分析</p>
<p class="ziti">（1）多实例本地登录MySQL</p>
<p class="ziti">多实例本地登录一般是通过socket文件来指定具体登录到哪个实例的，此文件的具体位置是在mysql编译过程或者my.cnf文件里指定的。在本地登录数据库时，登录程序会通过socket文件来判断登录的是哪个数据库实例。</p>
<p class="ziti">例如，通过“mysql-uroot-p'oldboy123'-S/data/3307/mysql.sock”可知，登录的是3307这个实例。mysql.sock文件是MySQL服务端与本地MySQL客户端进行通信的Unix套接字文件。</p>
<p class="ziti">（2）远程连接登录MySQL多实例</p>
<p class="ziti">远程登录MySQL多实例中的一个实例时，通过TCP端口（port）来指定所要登录的MySQL实例，此端口的配置是在MySQL配置文件my.cnf中指定的。</p>
<p class="ziti">例如，在“mysql-uoldboy-p'oldboy'-h 10.0.0.7-P 3307”中，“-P”为端口参数，后面接具体的实例端口，端口是一种“逻辑连接位置”，是客户端程序被分派到计算机上特殊服务程序的一种方式，强调的是提前在10.0.0.7上对oldboy用户做授权。</p>
</body>
</html>
