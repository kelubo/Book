<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_78">4.2.9　请求频率限制模块</h3> 
 <p class="ziti3">模块名称：ngx_http_limit_req_module</p> 
 <p class="ziti3">该模块会对指定变量的请求次数进行计数，当该变量在单位时间内的请求次数超过设定的数值时，后续请求会被延时处理，当被延时处理的请求数超过指定的队列数时，将返回指定的状态码（默认状态码为503）。通常该模块被用于限定同一IP客户端单位时间内请求的次数。该模块通过共享内存存储计数状态以实现多个工作进程间的同一变量计数状态的共享。该模块的内置配置指令如表4-41～表4-44所示。</p> 
 <p class="middle-img">表4-41　计数存储区指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-41.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-41.jpg" class="calibre140"/></a> 
 </div> 
 <p class="middle-img">表4-42　请求限制设置指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-42.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-42.jpg" class="calibre167"/></a> 
 </div> 
 <p class="middle-img">表4-43　请求限制日志级别指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-43.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-43.jpg" class="calibre168"/></a> 
 </div> 
 <p class="middle-img">表4-44　请求限制状态指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-44.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-44.jpg" class="calibre169"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">http {
    limit_req_zone $server_name zone=addr:10m rate=1r/s; 
                # 限制访问当前站点的请求数，对站点请求计数，将计数内存区命名为addr，
                # 设置计数内存区大小为10MB，请求限制为1秒1次
    server {
        location /search/ {
            limit_req zone=one;        
                # 同一秒只接收一个请求，其余的立即返回状态码503，直到第2秒才接收新的请求
            limit_req zone=one burst=5; 
                # 同一秒接收6个请求，其余的返回状态码503，只处理一个请求，其余5个请求进入队
　　　　　　　　　 # 列，每秒向Nginx释放一个请求进行处理，同时允许接收一个新的请求进入队列
            limit_req zone=one burst=5 nodelay;  
                # 同一秒接收6个请求，其余的返回状态码503，同时处理6个请求，6秒后再接收新的请求
        }
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·limit_req_zone的rate参数的作用是对请求频率进行限制，有r/s（每秒的请求次数）和r/m（每分钟的请求次数）两个频率单位，也可根据每秒的次数换算成毫秒单位的次数。1MB内存大小大约可以存储16 000个IP地址的状态信息。</p> 
 <p class="ziti4">·limit_req的burst参数相当于一个缓冲容器，该容器内可容纳burst所设置的数量的请求，没有nodelay参数时，将匀速向Nginx释放需要处理的请求。未进入burst容器队列的请求将被返回状态码503或由limit_req_status指令指定的状态码。</p> 
 <p class="ziti4">·limit_req的nodelay参数是指对请求队列中的请求不进行延时等待，而是立即处理。</p> 
 <p class="ziti4">·请求频率同样支持多个变量的同时计数及叠加，配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;
limit_req_zone $server_name zone=perserver:10m rate=10r/s;   

server {
    ...
    limit_req zone=perip burst=5 nodelay;
    limit_req zone=perserver burst=10;
}
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
