<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_65">4.1.2　根据IP动态赋值</h3> 
 <p class="ziti3">模块名称：ngx_http_geo_module</p> 
 <p class="ziti3">该模块的功能是从源变量获取IP地址，并根据设定的IP与对应值的列表对新变量进行赋值。该模块只有一个geo指令，指令格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">geo [源变量]新变量{}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·geo指令的默认源变量是$remote_addr，新变量默认值为空。</p> 
 <p class="ziti4">·geo指令的作用域只能是http。</p> 
 <p class="ziti3">该指令的指令值参数如表4-5所示。</p> 
 <p class="middle-img">表4-5　geo指令的指令值参数</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-5.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-5.jpg" class="calibre138"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">http{
    geo $country {
        proxy_recursive;                    # 启用代理递归查询
        default        ZZ;                  # 默认值为ZZ
        include        conf/geo.conf;       # 引入外部列表文件
        proxy          192.168.100.0/24;    # 上层代理地址为192.168.100.0/24的IP
        proxy          2001:0db8::/32;      # 上层代理地址为2001:0db8::/32的IP

        127.0.0.0/16   US;                  # 赋值US
        127.0.0.1/32   RU;                  # 赋值RU
        10.1.0.0/16    RU;                  # 赋值RU
        192.168.1.0/24 UK;                  # 赋值UK
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">为了加速加载IP来设定变量表，IP地址应按升序填写。</p> 
 <p class="ziti3">外部文件geo.conf的内容格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">10.2.0.0/16    RU;
192.168.2.0/24 RU;
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">以地址段形式定义的IP地址中ranges参数的配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">http{
    geo $country {
        ranges;                             # 使用以地址段的形式定义的IP地址
        default                   ZZ;
        10.1.0.0-10.1.255.255     RU;
        192.168.1.0-192.168.1.255 UK;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">自定义源变量配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">geo $arg_ip $address {                      # 设置请求参数IP为源变量
    default           CN;
    127.0.0.0/24      US;
    127.0.0.10/32     RU;
    10.1.0.0/16       RU;
    delete 127.0.0.10/32;                   # 删除127.0.0.10/32的设定
}

server {
    listen 8081;
    server_name localhost;
    charset utf-8;
    root /opt/nginx-web;
    default_type text/xml;

    location / {
        rewrite ^ /${address}.html break;   # 重定向到$address.html
    }
}
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
