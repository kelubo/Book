<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h2 class="p3" id="sigil_toc_id_69">4.2　访问控制功能模块</h2> 
 <h3 class="p" id="sigil_toc_id_70">4.2.1　访问镜像模块</h3> 
 <p class="ziti3">模块名称：ngx_http_mirror_module</p> 
 <p class="ziti3">该模块的功能是将用户的访问请求镜像复制到指定的URI，通过location的URI匹配将流量发送到指定的服务器。用户请求的实际请求响应通过Nginx返回客户端，镜像服务器的请求响应则会被Nginx服务器丢弃。镜像请求与实际请求是异步处理的，对实际请求无影响。该模块的内置配置指令如表4-15和表4-16所示。</p> 
 <p class="middle-img">表4-15　访问镜像指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-15.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-15.jpg" class="calibre35"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">server {
    listen 8080;
    root /opt/nginx-web/www;
    location / {
        mirror /benchmark;
        index index.html;
    }

    location = /benchmark {
        internal;
        proxy_pass http://192.168.2.145$request_uri;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="middle-img">表4-16　镜像请求体指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b4-16.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b4-16.jpg" class="calibre149"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">server {
    listen 8080;
    server_name localhost;
    root /opt/nginx-web/www;
    mirror_request_body off;
    location / {
        index index.html;
        mirror /accesslog;
    }

    location = /accesslog {
        internal;
        proxy_pass http://192.168.2.145/accesslog/${server_name}_$server_port$request_uri;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·如果该指令值为off则不同步请求体。</p> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">server {
    listen 8080;
    root /opt/nginx-web/www;
    location / {
        mirror /benchmark; # 镜像用户请求
        mirror /benchmark; # 镜像用户请求
        mirror /benchmark; # 镜像用户请求
        index index.html;
    }

    location = /benchmark {
        internal;
        proxy_pass http://192.168.2.145$request_uri;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·访问镜像模块可以将用户请求同步镜像到指定的服务器，同时还可以对用户的流量进行放大，通常可以在镜像线上流量后进行压力测试或预生产环境验证。</p> 
</body>
</html>
