<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_115">5.7.2　WebDAV协议服务</h3> 
 <p class="ziti3">WebDAV（Web-based Distributed Authoring and Versioning）是基于HTTP/1.1的增强协议。该协议使用户可以直接对Web服务器进行文件读写，并支持对文件的版本控制和写文件的加锁及解锁等操作。Nginx通过ngx_http_dav_module模块实现对WebDAV协议的支持，使用户通过WebDAV模块的配置指令实现文件的管理操作，该模块支持WebDAV协议的PUT、DELETE、MKCOL、COPY和MOVE请求方法，在配置编译参数时，需要添加--with-http_dav_module参数启用该功能。ngx_http_dav_module模块的配置指令如表5-10所示。</p> 
 <p class="middle-img">表5-10　WebDAV模块配置指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b5-10.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b5-10.jpg" class="calibre218"/></a> 
 </div> 
 <p class="ziti3">上述指令都可编写在http、server、location指令域中。</p> 
 <p class="ziti3">Nginx的自有模块对WebDAV协议的支持并不完整，可以通过第三方模块nginx-dav-ext-module增加文件特性查找和对写文件的加锁与解锁支持。ngx_http_dav_module模块的配置指令如表5-11所示。</p> 
 <p class="middle-img">表5-11　WebDAV扩展模块配置指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b5-11.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b5-11.jpg" class="calibre219"/></a> 
 </div> 
 <p class="ziti4">·dav_ext_lock_zone指令只能编写在http指令域中。</p> 
 <p class="ziti4">·dav_methods和dav_ext_lock指令可编写在http、server、location指令域中。</p> 
 <p class="ziti4">·WebDAV协议方法及方法说明如表5-12所示。</p> 
 <p class="middle-img">表5-12　WebDAV协议方法</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b5-12.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b5-12.jpg" class="calibre220"/></a> 
 </div> 
 <p class="ziti3">进行WebDAV协议的MOVE/COPY操作时，会通过HTTP请求头属性字段Destination指定目标路径，如果客户端请求头中没有字段Destination，Nginx会直接报错。为增加服务端兼容性，可以通过第三方模块headers-more-nginx-module的more_set_input_headers指令在MOVE/COPY操作的HTTP请求头中强制添加Destination字段。</p> 
 <p class="ziti3">WebDAV协议服务配置过程如下所示。</p> 
 <p class="ziti3">（1）模块编译</p> 
 <p class="ziti3">模块编译配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5"># 编译模块
$ ./configure --with-http_dav_module --add-module=../nginx-dav-ext-module --add-module=../headers-more-nginx-module
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（2）设置文件夹权限</p> 
 <p class="ziti3">文件夹权限配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">chown -R nobody:nobody /opt/nginx-web/davfile
chmod -R 700 /opt/nginx-web/davfile
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（3）设置登录账号及密码</p> 
 <p class="ziti3">登录账号及密码配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">echo "admin:$(openssl passwd 123456)" &gt;/etc/nginx/conf/.davpasswd
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（4）Nginx配置</p> 
 <p class="ziti3">Nginx配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">dav_ext_lock_zone zone=davlock:10m;                   # DAV文件锁内存共享区

server {
    listen 443 ssl http2;                             # 启用HTTPS及HTTP/2提升传输性能
    server_name  dav.nginxbar.org;
    access_log  logs/webdav.access.log  main;
    root    /opt/nginx-web/davfile;
    
    ssl_certificate ssl/www_nginxbar_org.pem;         # 网站证书文件
    ssl_certificate_key ssl/www_nginxbar_org.key;     # 网站证书密钥文件
    ssl_password_file ssl/www_nginxbar_org.pass;      # 网站证书密钥密码文件
    ssl_session_cache shared:SSL:10m;                 # 会话缓存存储大小为10MB
    ssl_session_timeout  20m;                         # 会话缓存超时时间为20分钟

    client_max_body_size 20G;                         # 最大允许上传的文件大小

    location / {
        autoindex on;
        autoindex_localtime on;

        set $dest $http_destination; 
        if (-d $request_filename) {                   # 对目录请求、对URI自动添加“/”
            rewrite ^(.*[^/])$ $1/;
            set $dest $dest/;
        }

        if ($request_method ~ (MOVE|COPY)) { # 对MOVE|COPY方法强制添加Destination请求头
            more_set_input_headers 'Destination: $dest';
        }

        if ($request_method ~ MKCOL) {
            rewrite ^(.*[^/])$ $1/ break;
        }

        dav_methods PUT DELETE MKCOL COPY MOVE;      # DAV支持的请求方法
        dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;# DAV扩展支持的请求方法
        dav_ext_lock zone=davlock;                   # DAV扩展锁绑定的内存区域
        create_full_put_path  on;                    # 启用创建目录支持
        dav_access user:rw group:r all:r;            # 设置创建的文件及目录的访问权限

        auth_basic "Authorized Users WebDAV";
        auth_basic_user_file /etc/nginx/conf/.davpasswd;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">主流操作系统均支持WebDAV协议，用户既可以直接通过添加网络设备的方式添加WebDAV网站目录，也可以使用支持WebDAV协议的客户端进行访问。</p> 
</body>
</html>
