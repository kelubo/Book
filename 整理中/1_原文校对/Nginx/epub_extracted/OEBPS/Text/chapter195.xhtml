<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_209">11.1.2　LVS简介</h3> 
 <p class="ziti3">LVS（Linux Virtual Server）是一个开源的负载均衡项目，是国内最早出现的开源项目之一，目前已被集成到Linux内核模块中。该项目在Linux内核中实现了基于TCP层的IP数据负载均衡分发，其工作在内核空间且仅做负载均衡分发处理，所以稳定性相对较好，性能相对较强，对内存及CPU资源的消耗也最低。</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/11-1.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/11-1.jpg" class="calibre325"/></a> 
 </div> 
 <p class="middle-img">图11-1　多层负载均衡网络架构</p> 
 <p class="ziti3"><span class="yanse">1.LVS术语</span></p> 
 <p class="ziti3">LVS相关术语说明如下。</p> 
 <p class="ziti4">·DS（Director Server）：控制器服务器，部署LVS软件的服务器。</p> 
 <p class="ziti4">·RS（Real Server）：真实服务器，被负载的后端服务器。</p> 
 <p class="ziti4">·VIP（Virtual IP）：虚拟IP，对外提供用户访问的IP地址。</p> 
 <p class="ziti4">·DIP（Director Server IP）：控制器服务器IP，控制器服务器的IP地址。</p> 
 <p class="ziti4">·RIP（Real Server IP）：真实服务器IP，真实服务器的IP地址。</p> 
 <p class="ziti4">·CIP（Client IP）：客户端IP，客户端的IP地址。</p> 
 <p class="ziti4">·IPVS（IP Virtual Server）：LVS的核心代码，工作于内核空间，主要有IP包处理、负载均衡算法、系统配置管理及网络链表处理等功能。</p> 
 <p class="ziti4">·ipvsadm：IPVS的管理器，工作于用户空间，负责IPVS运行规则的配置。</p> 
 <p class="ziti3"><span class="yanse">2.LVS工作原理</span></p> 
 <p class="ziti3">IPVS是基于Linux的Netfilter框架实现的，其以数据包的网络检测链为挂载点完成数据的负载均衡及转发处理。其工作原理如图11-2所示。</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/11-2.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/11-2.jpg" class="calibre326"/></a> 
 </div> 
 <p class="middle-img">图11-2　LVS工作原理</p> 
 <p class="ziti4">·客户访问虚拟IP（VIP）时，数据包先在主机内核空间被PREROUTING链检测，根据数据包的目标地址进行路由判断，若目标地址是本地，则交由INPUT链进行处理。</p> 
 <p class="ziti4">·IPVS工作于INPUT链，当数据包到达INPUT链时，会先由IPVS进行检查，并根据负载均衡算法选出真实服务器IP。</p> 
 <p class="ziti4">·IPVS转发模式为NAT模式时，将数据包由FORWARD链进行处理后由POST-ROUTING链发送给真实服务器。</p> 
 <p class="ziti4">·IPVS转发模式为非NAT模式时，则将数据包由POSTROUTING链发送给真实服务器。</p> 
 <p class="ziti3"><span class="yanse">3.LVS转发模式</span></p> 
 <p class="ziti3">LVS支持多种网络部署结构，官方版本提供了NAT、TUN及DR这3种标准转发模式，另阿里巴巴工程师根据自身需求进行扩展，实现了FullNAT转发模式。</p> 
 <p class="ziti3">1）LVS标准转发模式如下：</p> 
 <p class="ziti4">·NAT，该模式需要真实服务器的网关指向DS，客户端的请求包和返回包都要经过DS，该模式对DS的硬件性能的要求相对较高。</p> 
 <p class="ziti4">·TUN，该模式是将客户端的请求包通过IPIP方式封装后分发给真实服务器，客户端的返回包则由真实服务器的本地路由自行处理，源IP地址还是VIP地址（真实服务器需要在本地回环接口配置VIP）。因DS只负责请求包转发，其处理性能比NAT模式要高，但需要真实服务器支持IPIP协议。</p> 
 <p class="ziti4">·DR，该模式是将客户端的请求包通过修改MAC地址为真实服务器的MAC地址后将数据包分发给真实服务器，客户端的返回包则由真实服务器的本地路由自行处理，源IP地址还是VIP地址（真实服务器需要在本地回环接口配置VIP）。因DS只负责请求包转发，且与真实服务器间进行基于二层的数据分发，所以处理性能最高，但要求DS与真实服务器在同一MAC广播域内。</p> 
 <p class="ziti3">2）阿里扩展版本转发模式如下：</p> 
 <p class="ziti4">·FullNAT，该模式是客户端的请求包和返回包都要经过DS，但真实服务器可以在网络中的任意位置，且无须将网关配置为DS的IP地址，该方式虽然对DS的性能要求较高，但始终由DS面对客户端，有效保护了真实服务器的安全。</p> 
 <p class="ziti3">阿里扩展版本还针对LVS官方版本在安全方面进行了增强，提供了SYNPROXY功能支持，该功能在LVS上增加了一层foold类型的攻击包防护，实现了UDP/IP FRAG DDOS攻击防护。</p> 
 <p class="ziti3"><span class="yanse">4.LVS负载均衡算法</span></p> 
 <p class="ziti3">LVS实现了10种负载均衡算法，负载均衡算法及其功能介绍如表11-1所示。</p> 
 <p class="middle-img">表11-1　LVS负载均衡算法及其功能介绍</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-1.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-1.jpg" class="calibre327"/></a> 
 </div> 
 <p class="ziti3"><span class="yanse">5.IPVS的管理器ipvsadm</span></p> 
 <p class="ziti3">ipvsadm 1.2.1版本命令的常用场景分为虚拟服务管理和真实服务器管理两类。</p> 
 <p class="ziti3">（1）虚拟服务管理</p> 
 <p class="ziti3">在LVS配置管理中，每个VIP与端口组成一个虚拟服务。虚拟服务管理命令参数格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">ipvsadm -A [-t|u|f]  [vip_addr:port]  [-s:负载算法]
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">虚拟服务管理命令参数如表11-2所示。</p> 
 <p class="middle-img">表11-2　虚拟服务管理命令参数</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-2.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-2.jpg" class="calibre328"/></a> 
 </div> 
 <p class="ziti3">命令样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5"># 添加虚拟服务，VIP地址为192.168.2.100:80，协议为TCP，负载均衡算法为轮询算法（rr），启用保持
# 连接支持，默认超时时间为300s
ipvsadm -A -t 192.168.2.100:80 -s rr -p
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（2）真实服务器管理</p> 
 <p class="ziti3">真实服务器管理命令参数格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">ipvsadm -a [-t|u|f] [vip_addr:port] [-r ip_addr] [-g|i|m] [-w指定权重]
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">真实服务器管理命令参数如表11-3所示。</p> 
 <p class="middle-img">表11-3　真实服务器管理命令参数</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-3.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-3.jpg" class="calibre329"/></a> 
 </div> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/320-i.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/320-i.jpg" class="calibre330"/></a> 
 </div> 
 <p class="ziti3">命令样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5"># 在虚拟服务192.168.2.100:80中添加真实服务器192.168.10.3:80，转发模式为NAT模式
ipvsadm -a -t 192.168.2.100:80 -r 192.168.10.3:80 -m
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（3）其他常用命令参数</p> 
 <p class="ziti3">其他常用命令参数格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5"># 查看IPVS配置
ipvsadm -ln
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">更多命令参数可以通过man命令查看。</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">man ipvsadm
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
