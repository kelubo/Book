<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_127">6.2.4　基于SSL的TCP代理</h3> 
 <p class="ziti3">Nginx可以通过代理模块实现上游服务器SSL/TLS协议的连接，同时Nginx还通过模块ngx_stream_ssl_module提供了基于SSL/TLS协议的TCP连接监听。Nginx还可以把SSL证书部署在Nginx服务器上，这就减轻了后端上游服务器的CPU运算量并实现SSL证书的统一管理和维护。ngx_stream_ssl_module模块默认不会被构建，这就需要在编译的时候通过--with-stream_ssl_module参数进行启用。相关配置指令如表6-22所示。</p> 
 <p class="middle-img">表6-22　TCP/UDP SSL配置指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-22.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-22.jpg" class="calibre241"/></a> 
 </div> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/198-i.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/198-i.jpg" class="calibre242"/></a> 
 </div> 
 <p class="ziti4">·该模块指令值使用的指令域范围为stream、server。</p> 
 <p class="ziti4">·Nginx建立SSL TCP监听，用户发送SSL TCP连接时，由Nginx实现SSL终止并把TCP会话代理到上游服务器，部署方式为客户端→Nginx服务器（SSL TCP）→上游服务器（TCP）。配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    server {
        listen              636 ssl;                    # 设置监听端口为636 
        access_log logs/ldap_access.log tcp;

        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;      # 设置使用的SSL协议版本
        ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5; 
            # 设置服务端使用的密码套件
        ssl_certificate     ssl/www_nginxbar_org.pem;   # 主机名www.nginxbar.org证书文件
        ssl_certificate_key ssl/www_nginxbar_org.key;   # 主机名www.nginxbar.org证书密钥文件
        ssl_session_cache   shared:SSL:10m;             # SSL TCP会话缓存设置共享内存区域名为
                                                        # SSL，区域大小为10MB
        ssl_session_timeout 10m;                        # SSL TCP会话缓存超时时间为10分钟
        proxy_pass                    192.168.2.100:389;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·也可以通过代理模块的proxy_ssl指令配置与上游服务器实现全链路的安全数据通信。部署方式为客户端→Nginx服务器（SSL TCP）→被代理服务器（SSL TCP）。配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    server {
        listen              636 ssl;                   # 设置监听端口为636 
        access_log logs/ldap_access.log tcp;

        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;     # 设置使用的SSL协议版本
        ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5; 
            # 设置服务端使用的密码套件
        ssl_certificate     ssl/www_nginxbar_org.pem;  # 主机名www.nginxbar.org证书文件
        ssl_certificate_key ssl/www_nginxbar_org.key;  # 主机名www.nginxbar.org证书密钥文件
        ssl_session_cache   shared:SSL:10m;  # SSL TCP会话缓存设置共享内存区域名为SSL，区域大
                                               小为10MB
        ssl_session_timeout 10m;             # SSL TCP会话缓存超时时间为10分钟

        proxy_ssl   on;                      # 启用SSL/TLS协议，与被代理服务器建立连接
        proxy_ssl_session_reuse on;          # 与被代理服务器SSL TCP连接的SSL会话重用功能
    }
}
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
