<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_125">6.2.2　stream辅助模块</h3> 
 <p class="ziti3">（1）ngx_stream_map_module</p> 
 <p class="ziti3">该模块的功能是在客户端每次连接时，Nginx按照map指令域中源变量的当前值，把设定的对应值赋给新变量。该指令的语法格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">map 源变量 新变量{}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·这个指令使用的指令域只有stream。</p> 
 <p class="ziti4">·指令值参数如表6-6所示。</p> 
 <p class="middle-img">表6-6　map指令值参数</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-6.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-6.jpg" class="calibre53"/></a> 
 </div> 
 <p class="ziti4">·map指令域中，当源变量值存在相同匹配项时，匹配的顺序如下：</p> 
 <p class="ziti4">·完全匹配的字符串；</p> 
 <p class="ziti4">·有主机前缀的最长字符串；</p> 
 <p class="ziti4">·有主机后缀的最长字符串；</p> 
 <p class="ziti4">·在指令域中按自上而下的顺序最先匹配到的正则表达式；</p> 
 <p class="ziti4">·default参数给定的默认值。</p> 
 <p class="ziti3">map哈希表大小指令如表6-7所示。</p> 
 <p class="middle-img">表6-7　map哈希表大小指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-7.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-7.jpg" class="calibre154"/></a> 
 </div> 
 <p class="ziti3">map哈希桶大小指令如表6-8所示。</p> 
 <p class="middle-img">表6-8　map哈希桶大小指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-8.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-8.jpg" class="calibre141"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream{
    
    map $remote_addr $limit {
        127.0.0.1    “”;
        default      $binary_remote_addr;
    }

    limit_conn_zone $limit zone=addr:10m;
    limit_conn addr 1;
    server {
        listen 33060 reuseport;
        access_log  logs/tcp.log tcp;

        proxy_timeout 20s;
        proxy_pass 127.0.0.1:3306;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（2）ngx_stream_geo_module</p> 
 <p class="ziti3">该模块的功能是从源变量获取IP地址，并根据设定的IP与对应值的列表对新变量进行赋值。该模块只有一个geo指令，指令格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">geo [源变量]新变量{}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·geo指令的默认源变量是$remote_addr，新变量默认值为空。</p> 
 <p class="ziti4">·这个指令使用的指令域只有stream。</p> 
 <p class="ziti4">·指令值参数如表6-9所示。</p> 
 <p class="middle-img">表6-9　geo指令值参数</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-9.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-9.jpg" class="calibre231"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">geo $country {
    ranges;
    default                   CN;
    127.0.0.0-127.0.0.0       US;
    10.1.0.0-10.1.255.255     RU;
    192.168.1.0-192.168.1.255 UK;
}

geo $country {
    default        ZZ;
    include        conf/geo.conf;
    delete         127.0.0.0/16;

    127.0.0.0/24   US;
    10.1.0.0/16    RU;
    192.168.1.0/24 UK;
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（3）ngx_stream_geoip_module</p> 
 <p class="ziti3">该模块的功能首先是根据客户端的IP地址与MaxMind数据库中的城市地址信息做比对，然后再将对应的城市地址信息赋值给内置变量。</p> 
 <p class="ziti3">国家信息数据库指令如表6-10所示。</p> 
 <p class="middle-img">表6-10　国家信息数据库指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-10.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-10.jpg" class="calibre57"/></a> 
 </div> 
 <p class="ziti3">城市信息数据库指令如表6-11所示。</p> 
 <p class="middle-img">表6-11　城市信息数据库指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-11.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-11.jpg" class="calibre232"/></a> 
 </div> 
 <p class="ziti3">机构信息数据库指令如表6-12所示。</p> 
 <p class="middle-img">表6-12　机构信息数据库指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-12.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-12.jpg" class="calibre233"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    geoip_country         /usr/share/GeoIP/GeoIP.dat;
    geoip_city            /usr/share/GeoIP/GeoLiteCity.dat;

    map $geoip_city_continent_code $nearest_server {
        default        example.com;
        EU          eu.example.com;
        NA          na.example.com;
        AS          as.example.com;
    }
    ...
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（4）ngx_stream_split_clients_module</p> 
 <p class="ziti3">该模块会按照配置指令将一个0～232之间的数值根据设定的比例分割为多个数值范围，每个数值范围会被设定一个对应的给定值。用户每次请求时，指定的字符串会被计算出一个数值，该模块会将该数值所在范围对应的给定值赋值给配置中定义的变量。该功能常用来按照用户的来源IP进行访问流量分流。该指令的语法格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">split_clients 字符串 新变量 {}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    split_clients "${remote_addr}AAA" $upstream {  # ${remote_addr}AAA会被计算出一个数值
        0.5%     backend1;  # 数值在0 ~ 21474835之间，$upstream被赋值backend1
        80.0%    backend2;  # 数值在21474836 ~ 3435973836之间，$upstream被赋值backend2
        *        backend;   # 数值在3435973837 ~ 4294967295，$upstream被赋值backend
    }
    server {
        listen 389;
        proxy_pass $upstream;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·这个指令使用的指令域只有stream。</p> 
 <p class="ziti4">·客户端每次请求时，指定字符串会被使用MurmurHash2算法计算出一个0～232（0～4 294 967 295）之间的数值，该模块会将该数值所在范围对应的给定值赋值给配置中定义的变量。</p> 
 <p class="ziti3">（5）ngx_stream_ssl_preread_module</p> 
 <p class="ziti3">该模块可以在预读取阶段从ClientHello消息中提取信息，赋值给内置变量后供用户调用。</p> 
 <p class="ziti3">SSL信息预读如表6-13所示。</p> 
 <p class="middle-img">表6-13　SSL信息预读</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-13.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-13.jpg" class="calibre96"/></a> 
 </div> 
 <p class="ziti3">内置变量如表6-14所示。</p> 
 <p class="middle-img">表6-14　内置变量</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-14.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-14.jpg" class="calibre234"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    map $ssl_preread_protocol $upstream {
        ""        ssh.example.com:22;
        "TLSv1.2" new.example.com:443;
        default   tls.example.com:443;
    }

    server {
        listen      192.168.0.1:443;
        proxy_pass  $upstream;
        ssl_preread on;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（6）ngx_stream_limit_conn_module</p> 
 <p class="ziti3">该模块对访问连接中含有指定变量且变量值相同的连接数进行计数，当计数值达到limit_conn指令设定的值时，Nginx服务器将关闭此类连接。由于Nginx采用的是多进程的架构，因此该模块通过共享内存存储计数状态并实现了多个进程间的计数状态共享。</p> 
 <p class="ziti3">计数存储区指令如表6-15所示。</p> 
 <p class="middle-img">表6-15　计数存储区指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-15.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-15.jpg" class="calibre186"/></a> 
 </div> 
 <p class="ziti3">连接数设置指令如表6-16所示。</p> 
 <p class="middle-img">表6-16　连接数设置指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-16.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-16.jpg" class="calibre91"/></a> 
 </div> 
 <p class="ziti3">连接数日志级别指令如表6-17所示。</p> 
 <p class="middle-img">表6-17　连接数日志级别指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-17.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-17.jpg" class="calibre235"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    limit_conn_zone $binary_remote_addr zone=addr:10m; # 对客户端IP进行并发计数，计数内存区
                                                     # 命名为addr，计数内存区的大小为10MB
    server {
        limit_conn addr 1;                           # 限制客户端的并发连接数为1
        ...
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·limit_conn_zone的格式如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">limit_conn_zone key zone=name:size;
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·limit_conn_zone的key可以是文本、变量或文本与变量的组合。</p> 
 <p class="ziti4">·$binary_remote_addr为IPv4时，占用4B；为IPv6时，占用16B。</p> 
 <p class="ziti4">·limit_conn_zone中，1MB的内存空间可以存储32 000个32B或16 000个64B的变量计数状态。</p> 
 <p class="ziti4">·变量计数状态在32位系统平台占用32B或64B，在64位系统平台占用64B。</p> 
 <p class="ziti3">（7）ngx_stream_access_module</p> 
 <p class="ziti3">这个模块可以允许或拒绝客户端的源IP地址进行连接。</p> 
 <p class="ziti3">允许连接指令如表6-18所示。</p> 
 <p class="middle-img">表6-18　允许连接指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-18.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-18.jpg" class="calibre236"/></a> 
 </div> 
 <p class="ziti3">拒绝连续指令如表6-19所示。</p> 
 <p class="middle-img">表6-19　拒绝连接指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-19.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-19.jpg" class="calibre116"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    server {
        deny  192.168.1.1;          # 禁止192.168.1.1
        allow 192.168.0.0/24;       # 允许192.168.0.0/24的IP访问
        allow 10.1.1.0/16;          # 允许10.1.1.0/16的IP访问
        allow 2001:0db8::/32;
        deny  all;
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">Nginx按照自上而下的顺序进行匹配。</p> 
 <p class="ziti3">（8）ngx_stream_return_module</p> 
 <p class="ziti3">该模块向客户端返回指定值并关闭连接。</p> 
 <p class="ziti3">返回值指令如表6-20所示。</p> 
 <p class="middle-img">表6-20　返回值指令</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b6-20.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b6-20.jpg" class="calibre237"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">stream {
    server {
        listen 12345;
        return $time_iso8601; # 返回当前连接的时间
    }
}
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
