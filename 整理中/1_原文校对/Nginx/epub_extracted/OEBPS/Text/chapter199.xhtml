<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_213">11.2.1　Nginx集群配置管理规划</h3> 
 <p class="ziti3">Nginx的配置是以文件形式存在的，配置指令会在启动时一次性加载并生效，采用这种方式除upstream的配置可动态变更（商业版本支持API变更，开源版本依赖第三方模块动态修改）外，其他配置的修改均需要重启或热加载Nginx进程才可生效。为实现便捷的Nginx配置变更管理，需要从以下几个方面进行规划。</p> 
 <p class="ziti3"><span class="yanse">1.配置目录结构</span></p> 
 <p class="ziti3">Nginx默认所有配置文件均存放在其安装目录的conf目录下，为防止配置文件不方便阅读和管理，可以按照虚拟主机（具有独立主机名或网络端口）进行拆分，每个虚拟主机一个配置文件，并存放在统一的目录下。对功能固定、全局的配置指令以固定文件的形式存放在配置文件目录的根目录下。所有的配置文件都以nginx.conf为统一入口，并使用配置指令include按需引入。Nginx的目录结构规划样例如下。</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">conf/
  ├── conf.d
  │   ├── mysql_apps.ream
  │   ├── www.nginxbar.com.conf
  │   └── www.nginxbar.org.conf
  ├── fastcgi.conf
  ├── fastcgi_params
  ├── fscgi.conf
  ├── gzip.conf
  ├── mime.types
  ├── nginx.conf
  ├── proxy.conf
  ├── scgi_params
  ├── ssl
  │   ├── www_nginxbar_org.csr
  │   ├── www_nginxbar_org.key
  │   └── www_nginxbar_org.pem
  └── uwsgi_params
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti4">·Nginx默认配置文件目录结构说明可参见3.1.1节的相关内容。</p> 
 <p class="ziti4">·conf.d为自建目录，是存放虚拟主机配置文件的目录。</p> 
 <p class="ziti4">·mysql_apps.ream是自定义应用apps的MySQL集群代理配置文件。</p> 
 <p class="ziti4">·www.nginxbar.com.conf是域名<a href="http://www.nginxbar.com" class="pcalibre calibre1">www.nginxbar.com</a>对应的虚拟主机配置文件。</p> 
 <p class="ziti4">·www.nginxbar.org.conf是域名<a href="http://www.nginxbar.org" class="pcalibre calibre1">www.nginxbar.org</a>对应的虚拟主机配置文件。</p> 
 <p class="ziti4">·fscgi.conf是自定义FastCGI代理配置文件，配置文件样例可参见5.3.3节。</p> 
 <p class="ziti4">·gzip.conf是自定义响应数据gzip压缩配置指令文件，配置文件样例可参见4.3.5节。</p> 
 <p class="ziti4">·proxy.conf是自定义HTTP代理配置指令文件，配置文件样例可参见6.1.3节。</p> 
 <p class="ziti4">·ssl是自建目录，用于存放虚拟主机的SSL证书文件。</p> 
 <p class="ziti3">nginx.conf配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5"># 选择加载动态模块
load_module "modules/ngx_http_geoip_module.so";
load_module "modules/ngx_http_image_filter_module.so";
load_module "modules/ngx_http_xslt_filter_module.so";

# 工作进程及事件配置
worker_processes auto;                  # 启动与CPU核数一致的工作进程
worker_priority -5;                     # 工作进程在linux系统中的优先级为-5

events {
    worker_connections  65535;              # 每个工作进程的最大连接数
    multi_accept on;                        # 每个工作进程每次都可以接收多个连接
}

# TCP/UDP代理配置
stream {
    # 配置TCP/UDP代理的日志格式模板，模板名为tcp
    log_format  tcp  '$remote_addr - $connection - [$time_local] $server_addr:$server_port - $protocol'
                      '- $status - $upstream_addr - $bytes_received - $bytes_sent - $session_time '
                      '- $proxy_protocol_addr:$proxy_protocol_port ';

    # 配置TCP/UDP代理的错误日志输出位置，错误级别为error
    error_log logs/tcp_error.log error;

    # 引入conf.d目录下所有后缀名为ream的配置文件
    include conf.d/*.ream;
}

# HTTP配置
http {
    include       mime.types;               # 引入MIME类型映射表文件

    # 配置HTTP的错误日志输出位置，错误级别为error
    error_log logs/error.log error;

    # 配置HTTP的日志格式，模板名为main
    log_format  main  '$remote_addr - $connection - $remote_user [$time_local] "$request" - $upstream_addr '
                      '$status  - $body_bytes_sent - $request_time - "$http_referer" '
                      '"$http_user_agent" - "$http_x_forwarded_for" - ';

    # 配置全局访问日志输出位置，并以模板main的日志格式输出
    access_log  logs/access.log  main;

    charset  utf-8;                         # 字符编码为utf-8
    variables_hash_max_size 2048;           # 变量哈希表最大值为2048B
    variables_hash_bucket_size 128;         # 变量哈希桶最大值为128B
    server_names_hash_bucket_size 256;      # 服务主机名哈希桶大小为256B
    client_header_buffer_size 32k;          # 请求头缓冲区大小为32KB
    large_client_header_buffers 4 128k;     # 最大缓存为4个128KB
    client_max_body_size 20m;               # 允许客户端请求的最大单个文件字节数为20MB
    sendfile on;                            # 开启零复制机制
    tcp_nopush on;                          # 启用在零复制时数据包最小传输的限制机制
    tcp_nodelay on;                         # 当处于保持连接状态时以最快的方式发送数据包
    keepalive_timeout  60;                  # 保持连接超时时间为60s
    client_header_timeout 10;               # 读取客户请求头的超时时间是10s
    client_body_timeout 10;                 # 请求体接收超时时间为10s
    server_tokens on;                       # 不显示Nginx版本信息
    include gzip.conf;                      # HTTP gzip的配置文件
    include proxy.conf;                     # HTTP代理配置
    include conf.d/*.conf;                  # 引入HTTP虚拟主机配置
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">nginx.conf中编辑在全局区域的配置指令均可按照Nginx配置指令规范在server、location指令域中被同名的配置指令覆盖。</p> 
 <p class="ziti3"><span class="yanse">2.配置归档</span></p> 
 <p class="ziti3">Nginx作为负载均衡应用时，是业务应用的入口，Nginx服务器的可用性决定了其所负责的所有被代理业务的可用性。所以Nginx进行配置变更时要及时做好归档和版本控制，因为Nginx配置是以文件方式存在的，所以可以将每次修改的文件以Git标签的方式在Git仓库中进行存档和版本控制。</p> 
 <p class="ziti3"><span class="yanse">3.配置变更</span></p> 
 <p class="ziti3">可以使用对应的配置模板进行Nginx配置内容的修改、配置部分的标准化及通用性约定，以便进行自动化操作。开源软件Ansible提供了自定义模板的功能，使用户可以按照预期设计更加严谨、规范地配置变更。Ansible支持批量操作，可以快速完成多台Nginx服务器配置文件的同步和加载。</p> 
 <p class="ziti3"><span class="yanse">4.配置发布</span></p> 
 <p class="ziti3">Ansible虽然提供了命令行的操作能力，但是用户权限、操作日志及快速回滚等操作仍不够便捷。Jenkins是一款Web化的持续集成发布工具，被广泛应用于业务应用的发布，拥有超过1000个插件，用户无须额外开发就可快速完成代码从代码仓库到运行部署的整个流程，同时还支持用户权限、操作日志及快速回滚等操作。</p> 
 <p class="ziti3">根据上述4个方面的规划，通过Jenkins与GitLab及Ansible的配合使用，无须复杂编程就可以快速搭建一套Web化的Nginx配置管理系统。应用架构如图11-5所示。</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/11-5.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/11-5.jpg" class="calibre340"/></a> 
 </div> 
 <p class="middle-img">图11-5　应用架构图</p> 
 <p class="ziti4">·Jenkins通过GitLab获取Git仓库中的Nginx文件。</p> 
 <p class="ziti4">·Ansible根据Jenkins Web界面输入的参数与对应配置模板生成配置文件，更新本地的Nginx配置文件。</p> 
 <p class="ziti4">·Ansible将更新后的配置文件同步到Nginx集群的所有Nginx服务器，并对Nginx进程执行reload操作，以加载更新后的配置。</p> 
 <p class="ziti4">·Jenkins将更新后的Nginx配置文件以Git标签的方式进行归档。</p> 
 <p class="ziti4">·用户可以通过Jenkins获取对应Git仓库的所有Git标签，并根据需求选择对应的Git标签代码执行回滚操作。</p> 
</body>
</html>
