<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre"> 
 <h3 class="p" id="sigil_toc_id_210">11.1.3　Keepalived简介</h3> 
 <p class="ziti3">Keepalived是一款用C语言编写的开源路由软件，目前仍处于活跃开发的状态，其主要目标是基于Linux系统提供一款配置简单且功能强大的负载均衡和高可用的软件应用。负载均衡是基于LVS（IPVS）实现的，Keepalived在LVS的基础上增加了多种主动健康检测机制，可以根据后端真实服务器的运行状态，自动对虚拟服务器负载的真实服务器进行维护和管理。高可用性是通过虚拟冗余路由协议（Virtual Reduntant Routing Protocol，VRRP）实现的。VRRP是工作在网络层的一种路由容错协议，通过组播的通告机制进行网络路由快速转移，以实现网络设备的高可用。</p> 
 <p class="ziti3"><span class="yanse">1.Keepalived相关术语</span></p> 
 <p class="ziti3">Keepalived相关术语如下：</p> 
 <p class="ziti4">·虚拟IP（VIP）：对外提供用户访问的IP地址，与LVS的VIP概念相同。</p> 
 <p class="ziti4">·真实服务器（Real Server）：被负载的后端服务器。</p> 
 <p class="ziti4">·服务器池（Server Pool）：同一虚拟IP及端口的一组真实服务器。</p> 
 <p class="ziti4">·虚拟服务器（Virtual Server）：服务器池的外部访问点，每个虚拟IP和端口组成一个虚拟服务器。</p> 
 <p class="ziti4">·虚拟服务（Virtual Service）：与VIP关联的TCP/UDP服务。</p> 
 <p class="ziti4">·VRRP：Keepalived实现高可用的虚拟路由器冗余协议。</p> 
 <p class="ziti4">·VRRP路由器（VRRP Router）：运行VRRP协议的路由器设备。</p> 
 <p class="ziti4">·虚拟路由器（Virtual Router）：一个抽象对象，一组具有相同VRID（虚拟路由器标识符）的多个VRRP路由器集合。</p> 
 <p class="ziti4">·MASTER状态：主路由状态，是VIP地址的拥有者，负责转发到达虚拟路由的三层数据包，负责对虚拟IP地址的ARP请求进行响应。</p> 
 <p class="ziti4">·BACKUP状态：备份路由状态，当主路由状态设备故障时，负责接管数据包转发及ARP请求响应。</p> 
 <p class="ziti3"><span class="yanse">2.Keepalived的工作模式</span></p> 
 <p class="ziti3">Keepalived为LVS提供了文件形式的配置方式，并为真实服务器提供了多种主动健康检测机制，通过VRRP协议为LVS提供了高可用的负载集群解决方案。Keepalived的工作模式如图11-3所示。</p> 
 <p class="ziti4">·处于MASTER状态的Keepalived主机是VIP的拥有者，负责上层路由VIP的ARP查询响应和数据包转发。</p> 
 <p class="ziti4">·处于MASTER状态的Keepalived主机通过VRRP协议在局域网内组播VRRP通告信息。</p> 
 <p class="ziti4">·处于MASTER状态的Keepalived主机通过配置的健康检测机制主动检查服务器池中真实服务器的状态。</p> 
 <p class="ziti4">·处于BACKUP状态的Keepalived主机接收VRRP通告信息，并根据通告信息判断本机状态是否变更。</p> 
 <p class="ziti4">·当处于MASTER状态的路由发生故障时，处于BACKUP状态的路由确认主路由状态的VRRP通告超时时，则改变自身状态为MASTER状态，负责上层路由IP地址的ARP请求响应，并对外组播VRRP通告。</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/11-3.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/11-3.jpg" class="calibre331"/></a> 
 </div> 
 <p class="middle-img">图11-3　Keepalived的工作模式示意图<br class="calibre3"/></p> 
 <p class="ziti3"><span class="yanse">3.健康检测</span></p> 
 <p class="ziti3">Keepalived设计了多种主动健康检测机制，每个健康检测机制都注册在全局调度框架中，通过检测真实服务器的运行状态，自动对服务池中的真实服务器进行维护和管理。常用的健康检测机制有以下4种。</p> 
 <p class="ziti4">·TCP检测。通过非阻塞式TCP连接超时检查机制检查真实服务器的状态，当真实服务器不响应请求或响应超时时，则确认为检测失败，并将该真实服务器从服务池中移除。</p> 
 <p class="ziti4">·HTTP检测。通过HTTP GET方法访问指定的URL并对返回结果进行MD5算法求值，如果与配置文件中的预设值不匹配，则确认为检测失败，并将该真实服务器从服务池中移除。该机制支持同一服务器的多URL获取检测。</p> 
 <p class="ziti4">·SSL检测。对HTTP检测增加了SSL支持。</p> 
 <p class="ziti4">·自定义脚本。允许用户自定义检测脚本进行检测判断，支持脚本外部传递参数，执行的结果必须是0或1。0表示检测成功，1表示检测失败。</p> 
 <p class="ziti3"><span class="yanse">4.配置关键字</span></p> 
 <p class="ziti3">Keepalived配置文件可以分为3个部分，分别为全局配置、VRRP配置和虚拟服务配置。各部分的常用配置关键字及其功能如下。</p> 
 <p class="ziti3">（1）全局配置</p> 
 <p class="ziti3">Keepalived全局配置关键字实现邮件告警的SMTP配置及自身VRRP路由相关的全局配置，配置关键字如表11-4所示。</p> 
 <p class="middle-img">表11-4　全局配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-4.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-4.jpg" class="calibre332"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">global_defs{
    notification_email {
        monitor@nginxbar.org        # 接收邮件的邮箱为monitor@nginxbar.org
    }
    smtp_server smtp.nginxbar.org   # SMTP服务器地址为smtp.nginxbar.org
    smtp_connect_timeout 30 # SMTP服务器连接超时时间为30秒
    router_id LVS_Nginx1            # 当前设备路由ID为LVS_Nginx1
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（2）VRRP配置</p> 
 <p class="ziti3">Keepalived的VRRP配置关键字用于创建VRRP路由器，并为其配置运行参数。配置文件中可以创建多个不同名称的VRRP路由器实例，每个VRRP路由器实例都需要通过设定虚拟路由ID加入虚拟路由器中。VRRP路由器接收组播的VRRP通告，并根据VRRP通告切换自身状态。当切换状态时会触发配置中对应状态的shell脚本，并根据配置参数判断是否发送告警邮件。VRRP配置关键字如表11-5所示。</p> 
 <p class="middle-img">表11-5　VRRP配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-5.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-5.jpg" class="calibre333"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">vrrp_instance VI_1 {
    state MASTER            # 初始路由状态为MASTER
    interface eth0          # VRRP绑定接口为eth0
    virtual_router_id 51    # 虚拟路由器的VRID为51
    priority 100    # 当前设备的优先级是100
    nopreempt               # 不参与MASTER的选举
    advert_int 5            # VRRP组播的间隔时间是5秒
    authentication {
        auth_type PASS      # 认证类型为PASS
        auth_pass 2222      # 认证密码为2222
    }
    virtual_ipaddress {
        192.168.2.155       # 虚拟服务器的VIP是192.168.2.155
    }
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">VRRP本身是通过VRRP通告机制实现路由器状态切换判断的，但在实际的应用场景中会存在因网络抖动等原因影响VRRP的通告传递的情况，为提高状态切换的准确性，Keepalived还提供了一种脚本检测机制，可以让用户通过自定义脚本更精准地进行路由状态切换。相关配置关键字如表11-6所示。</p> 
 <p class="middle-img">表11-6　VRRP检测配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-6.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-6.jpg" class="calibre334"/></a> 
 </div> 
 <p class="ziti3">Keepalived通过VRRP通告判断虚拟路由器中其他VRRP路由状态并确保路由的转移，对于业务层的高可用，则需要用户单独对应用进程进行同步检测。例如，Nginx与Keepalived部署在同一台设备上，可以通过脚本检测Nginx进程的状态，如果Nginx检测失败并无法自动恢复，则降低VRRP的优先级。要尽量避免在切换为MASTER状态时，因自身业务层故障导致业务高可用切换失败。也可用多个脚本组合实现VRRP路由优先级的动态调整。配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">vrrp_script checknginx {
    script "/opt/data/scripts/checknginx.sh"
    interval 3      # 检测脚本执行时间间隔
    weight -20      # 当检测失败时，VRRP路由优先级降低20
    rise 3          # 连续监测3次成功才确认为成功
    fall 3          # 连续监测3次失败才确认为失败
}
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">检测脚本内容如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">#!/bin/bash
# 检测脚本查询Nginx进程是否存在，若存在则返回0，若检测失败则返回1
check = `ps aux | grep -v grep | grep nginx | wc -l`
if [ $check &gt; 0 ]; then
    exit 0
else
    systemctl start nginx
    exit 1
fi
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">（3）虚拟服务器配置</p> 
 <p class="ziti3">Keepalived的虚拟服务器是负载均衡的外部访问点，通过配置关键字实现对LVS运行参数的配置，配置文件中可以为VIP绑定不同的端口创建多个虚拟服务器。虚拟服务器配置关键字如表11-7所示。</p> 
 <p class="middle-img">表11-7　虚拟服务器配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-7.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-7.jpg" class="calibre335"/></a> 
 </div> 
 <p class="ziti3">真实服务器相关关键字如表11-8所示。</p> 
 <p class="middle-img">表11-8　真实服务器配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-8.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-8.jpg" class="calibre336"/></a> 
 </div> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/326-i.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/326-i.jpg" class="calibre337"/></a> 
 </div> 
 <p class="ziti3">通过Keepalived为真实服务器配置关键字不仅可以实现LVS真实服务器的运行参数配置，还可以对自身增加的真实服务器的主动健康检测进行配置。真实服务器健康检测配置关键字如表11-9所示。</p> 
 <p class="middle-img">表11-9　真实服务器健康检测配置关键字</p> 
 <div class="pic"> 
  <a href="http://popImage?src='../Images/b11-9.jpg'" class="pcalibre calibre1"><img alt="" src="../Images/b11-9.jpg" class="calibre338"/></a> 
 </div> 
 <p class="ziti3">配置样例如下：</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">virtual_server 192.168.2.155 80 {               # 虚拟服务器IP及端口
    delay_loop 6                            # 健康检测间隔时间为6s
    lb_algo wrr                             # 负载均衡调度算法为加权轮询
    lb_kind DR                           # 转发模式为DR
    persistence_timeout 60                  # 保持连接的超时时间为60s
    protocol TCP                            # 负载均衡转发协议为TCP
    real_server 192.168.2.109 80 {                  # 真实服务器IP及端口
        weight 100                                  # 真实服务器权重为100
        notify_down /etc/keepalived/scripts/stop.sh # 当真实服务器健康检测失败时执
                                                                # 行stop.sh脚本
        HTTP_GET {
            url {
                path "/healthcheck"                 # 指定要检查的URL的路径
                digest bfaa324fdd71444e43eca3b7a1679a1a     # 检测URL返回值的MD5计算值
                status_code 200                             # 健康检测返回状态码
            }
            connect_timeout 10                      # 连接超时时间为10s
            nb_get_retry 3                          # 重试3次确认失败
            delay_before_retry 3                    # 失败重试的时间间隔为3s
        }
    }
}

# digest值的计算方法
genhash -s 192.168.2.109 -p 80 -u /healthcheck
</pre> 
 <hr class="calibre6"/> 
 <p class="ziti3">Keepalived的其他配置关键字此处并未列出，更多配置关键字可以通过man命令获取。</p> 
 <hr class="calibre6"/> 
 <pre class="ziti5">man keepalived.conf
</pre> 
 <hr class="calibre6"/> 
</body>
</html>
