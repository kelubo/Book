<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>未知</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="../../stylesheet.css"/>
<link rel="stylesheet" type="text/css" href="../../page_styles.css"/>
</head>
  <body class="calibre">
  <h3 class="p" id="sigil_toc_id_171">8.4.2　TCP/UDP负载均衡的容错机制</h3>

  <p class="ziti3">Nginx的TCP/UDP负载均衡在连接分配时也支持被动健康检测模式，如果与后端服务器建立连接失败，并在fail_timeout参数的时间内连续超过max_fails参数设置的次数，Nginx就会将该服务器置为不可用状态，并且在fail_timeout参数的时间内不再给该服务器分配连接。当fail_timeout参数的时间结束时将尝试分配连接检测该服务器是否恢复，如果可以建立连接，则判定为恢复。</p>

  <p class="ziti3">配置样例如下：</p>
  <hr class="calibre6"/>
  <pre class="ziti5">stream {
    upstream backend {
        # 10s内出现3次错误，该服务器将被熔断10s
        server 192.168.2.154:8080 max_fails=3 fail_timeout=10s; 
        server 192.168.2.109:8080 max_fails=3 fail_timeout=10s;
        server 192.168.2.108:8080 max_fails=3 fail_timeout=10s;
        server 192.168.2.107:8080 max_fails=3 fail_timeout=10s;
    }

    server {
        proxy_connect_timeout 5s;           # 与被代理服务器建立连接的超时时间为5s
        proxy_timeout 10s;          # 获取被代理服务器的响应最大超时时间为10s

        # 当被代理的服务器返回错误或超时时，将未返回响应的客户端连接请求传递给upstream中的下
        # 一个服务器
        proxy_next_upstream on;
        proxy_next_upstream_tries 3;        # 转发尝试请求最多3次
        proxy_next_upstream_timeout 10s;    # 总尝试超时时间为10s
        proxy_socket_keepalive on;  # 开启SO_KEEPALIVE选项进行心跳检测
        proxy_pass backend;
    }
}
</pre>
  <hr class="calibre6"/>

  <p class="ziti3">其中的参数及指令说明如下。</p>

  <p class="ziti4">·指令值参数max_fails是指10s内Nginx分配给当前服务器的连接失败次数累加值，每10s会重置为0。</p>

  <p class="ziti4">·指令值参数fail_timeout既是失败计数的最大时间，又是服务器被置为失败状态的熔断时间，超过这个时间将再次被分配连接。</p>

  <p class="ziti4">·指令proxy_connect_timeout或proxy_timeout为超时状态时，都会触发proxy_next_upstream机制。</p>

  <p class="ziti4">·proxy_next_upstream是Nginx下提高连接成功率的机制，当被代理服务器返回错误或超时时，将尝试转发给下一个可用的被代理服务器。</p>

  <p class="ziti4">·指令proxy_next_upstream_tries的指令值次数包括第一次转发请求的次数。</p>

  <p class="ziti3">TCP连接在接收到关闭连接通知前将一直保持连接，当Nginx与被代理服务器的两个连续成功的读或写操作的最大间隔时间超过proxy_timeout指令配置的时间时，连接将会被关闭。在TCP长连接的场景中，应适当调整proxy_timeout的设置，同时关注系统内核SO_KEEPALIVE选项的配置，可以防止过早地断开连接。</p>
</body>
</html>
