% 只是为了好玩
% 只是为了好玩.tex

\documentclass[12pt,UTF8]{ctexbook}

% 设置纸张信息。
\input{../../../common/page}

% 设置字体，并解决显示难检字问题。
\xeCJKsetup{AutoFallBack=true}
\setCJKmainfont{SimSun}[BoldFont=SimHei, ItalicFont=KaiTi, FallBack=SimSun-ExtB]

% 目录 chapter 级别加点（.）。
\usepackage{titletoc}
\titlecontents{chapter}[0pt]{\vspace{3mm}\bf\addvspace{2pt}\filright}{\contentspush{\thecontentslabel\hspace{0.8em}}}{}{\titlerule*[8pt]{.}\contentspage}

% 设置 part 和 chapter 标题格式。
\ctexset{
	part/name= {第,卷},
	part/number={\arabic{part}},
	chapter/name={第,篇},
	chapter/number={\arabic{chapter}}
}

% 图片相关设置。
\usepackage{graphicx}
\graphicspath{{Images/}}

% 设置署名格式。
\newenvironment{shuming}{\hfill\zihao{4}}

% 注脚每页重新编号，避免编号过大。
\usepackage[perpage]{footmisc}

\title{\heiti\zihao{0} OpenWrt}
\author{}
\date{}

\begin{document}

\maketitle
\tableofcontents

\frontmatter

\chapter{前言}

由于路由器大量采用了开源操作系统，哥伦比亚大学法学院教授 Eben Moglen 向路由器厂商提出了开源路由器系统部分的要求，就这样，2004 年 OpenWrt 诞生了 White Russian 版，之后每一两年便发布一个最新的版本。今天，OpenWrt 系统在智能路由器行业已是事实性标准，大量的芯片厂商及路由器厂商（包括小米、极路由、极企科技等知名互联网科技企业）均采用该系统作为路由器或智能家居控制中心，即使宣称没有使用 OpenWrt 的厂商，也多是在该系统基础之上进行了业务定制。

学做智能设备的几大误区：

（1）需要具备硬件知识：

学习智能设备上的软件开发和硬件调试确实需要具备一定的硬件知识，但是所需具备的硬件知识非常非常少，少到几乎可以在几小时之内掌握，因此阅读本书的读者不需要事先具备硬件知识，但是我们希望读者具备良好的动手能力。

（2）需要懂嵌入式开发，能写驱动程序：

完全不需要，本书中Linux相关的知识跟我们计算机上的大部分知识都是通用的，考虑到有很多读者连Linux都没有使用过，书中也加上了Linux部分的内容让读者学习。

（3）需要具备多年的开发经验：

也是不需要的，本书推荐读者熟悉某种编程语言，这样可以方便理解各类知识，但是对编程语言以及平台没有任何要求，随便哪一种都可以，即使是GWBASIC这种语言都行。

\mainmatter

\chapter{路由器}

\section{传统路由器}

全世界近80\%的路由器是在中国生产的，其中约有50\%的路由器是在中国研发的，传统的路由器厂商使用几大路由器芯片厂商提供的设计方案进行产品设计。这些芯片厂商会给路由器厂商提供资料、电路板设计原理图、软件SDK。其实很多人可能不知道，芯片厂家所提供的资料完善到你难以想象的地步，只需要有一台老旧计算机，随便一编译，自己做个板子，再随意弄个外观就可以完成路由器设计。因此，传统路由器厂商能用来提升营收和竞争力的手段就只剩下价格和外观了，为此这个行业进入了一种越做越烂的循环模式。而在这之外，一些在成本上不具备优势的小厂商，为了获得利润和生存空间，普遍使用违规的功率放大装置，做出让你觉得信号很强的产品，成为了灰色地带。

由于国内的传统路由器厂商过于注意外观（比如路由器必须有天线，因为客户觉得有天线信号才会强），不注重软件（芯片厂家连Web都做了，没自己啥事），所以普遍不重视技术培养和研发，如今在智能路由大行其道的时候，他们往往陷入了被动。像TP-Link、磊科这种大厂已经在加强这方面投入，取得了可喜的成绩，值得肯定。

\section{智能路由器}

所谓智能路由器，有人定义为它像个人计算机一样，具有独立的操作系统，用户可自行安装软件控制带宽、上网加速、过滤视频广告等，远不局限于无线上网的功能。它将一个功能单一的产品变成了一个平台，在这个平台上面，可以安装App插件来增加新的功能，例如游戏加速、下载加速和全球加速，同时还可以增加新的使用场景，比如用路由器无线播放音乐等。问题是，路由器这个多年未变的市场，为何会突然出现智能路由器的概念和产品？

智能路由器也就是智能化管理的路由器，通常具有独立的操作系统，可以由用户自行安装各种应用，自行控制带宽、在线人数、浏览网页和在线时间，同时拥有强大的USB共享功能，真正做到网络和设备的智能化管理。

智能路由从2013年开始逐渐升温，互联网公司开始关注传统路由器这个发展了十几年没有任何技术革新的产业，作为家庭、企业的入口设备和控制中心，路由器的可想象空间变得更大。由于路由器芯片的性能不断增强，现在我们所看到的路由器在性能和配置上已经接近十几年前的计算机，并且即将超越，同时具备了更低的功率、更高的性能。

只要你有一款智能路由器，你就可以将它和任何一种智能设备连接在一起。当前大部分智能路由器采用了OpenWrt这个开源路由器操作系统作为自己的系统，然后对系统进行修改，做个有自主知识产权的产品。

\section{传统路由器与智能路由器的区别}

智能路由器，不同厂商的产品有不同的功能，有的有屏幕，有的可以实现网络加速，甚至有的可以直接播放音乐，但是如果要对传统路由器与智能路由器两类设备用一句话来区分，那就是“智能路由器可以单独安装软件”。

\chapter{OpenWrt介绍}

\section{什么是OpenWrt}

OpenWrt和DD-Wrt等是现在很多智能路由设备的操作系统。虽然没有某一个厂商专门单独推出这样一个开源的产品，但OpenWrt在中国已经成为了智能路由器的标准配备。

来自美国的OpenWrt社区对OpenWrt做了一个简短而精准的说明：“OpenWrt就是为嵌入式设备所研发的Linux发行版”。当年Linksys开放了一款路由器的源代码，然后就有不同的黑客对这个源代码打补丁用以实现不同的功能，最后就出现了针对不同市场的杂乱无章的路由器固件。

OpenWrt选择了另外一条路，从开始的那一刻起，它就一点点把各种软件和玩意加到系统中，采用了一个非常灵活并且开放式的方法，这样的结果就令全世界所有的厂商和爱好者都能加强OpenWrt的功能，而开放式架构也令OpenWrt支持数量繁多的芯片，从x86到ARM、MIPS等各种稀奇古怪的芯片。而开发者使用OpenWrt，只需要直接通过简单的编译，就可以将一套软件编译出不同芯片的版本，烧写到自己的路由器上就拥有了一台Linux服务器。OpenWrt还支持一种称为OPKG的增强型安装技术，OPKG是OpenWrt PackageManagement，在OpenWrt下的一款轻量级软件包管理工具，OPKG使用起来就像CentOS下的YUM一样，一个命令就可以将已预编译好的软件安装到系统中。

从2005年2月截至今日，OpenWrt已经支持了一千多种软件，并且自己移植软件到OpenWrt中变得非常容易。OpenWrt系统高度模块化。

\section{哪些产品用了OpenWrt}

·极路由：极壹S

·极路由：极硬货

·极路由：极贰

·极路由：极壹

·小米：小米路由器

·小米：小米路由器mini

·盛大果壳：魔豆路由（类OpenWrt）

·联想：新路由

以上只列出了市面上较为流行的智能路由器，实际使用的远超过此列表。而以上列表中的大部分硬件都与本书所讲的MR808开发板兼容。

\section{OpenWrt是如何支持路由器CPU的}

一般，这种支持要么是水平极高并且是芯片厂合作伙伴的人实现的，要么是芯片厂的内部人士实现的。想要支持路由器CPU说起来并不难，只需要两部分的支持。一是在汇编层面让OpenWrt编译时支持所属路由器CPU的指令集，方便编译出软件，在路由器上运行。这部分基本上是可以支持的，现在大部分路由器采用的都是MIPS指令集，这是Linux已经支持的。二是驱动程序了，外围的厂商也不容易写出驱动程序，所以大部分驱动程序要么是芯片厂直接提供的，要么是有更亲密关系的厂商写的。

有一个好消息，目前市面上的路由器CPU厂商都已经开始重视OpenWrt系统，虽然它们还不愿意做到首先支持OpenWrt，但在芯片上市半年左右都会推出对OpenWrt的支持，值得赞扬！

\chapter{智能路由器硬件}

\section{MIPS架构}

现在的智能路由器，其核心部分与我们的计算机没有太大的区别，无非就是CPU配合存储器，加上一些外围电路，没什么特别“高大上”的地方。

近10年来，路由器所采用的CPU主要是基于MIPS架构设计的。说到MIPS，可能很多人感到陌生；说到龙芯，了解的人就比较多了，龙芯便是MIPS架构下的一种处理器。

MIPS架构是由斯坦福大学的教授约翰·轩尼诗在闲得无聊的时候带领他的团队开发出来的一款处理器。在随后的3年时间里，他创立了MIPS科技公司。MIPS采用了RISC精简指令集设计技术，RISC是精简指令集的简称，是芯片的一种设计模式，相比CISC（复杂指令集）具有更高的执行效率。MIPS架构处理器在当时刷新了32位处理器性能的历史。在2002年，中国研发龙芯处理器，龙芯处理器采用了MIPS架构但是没有经过MIPS公司授权而遭到起诉，2009年与MIPS公司和解。

MIPS架构在历史上曾经是三国时期（x86、MIPS、PowerPC）的佼佼者，在2000年的时候，hoowa记得国内可以买到一款叫作Cobalt的基于MIPS架构的服务器（Sun公司为抢占市场收购了Cobalt Network公司）。

国内常见路由器的配置
国内常见路由器的配置见表3-1。
表3-1 国内常见路由器硬件配置
续表


\backmatter

书名：OpenWrt智能路由系统开发——跟hoowa学智能路由
作者：王伟，孙冰，刘龙
出版社：人民邮电出版社
出版时间：2018-03
ISBN：978-7-115-47711-8

\end{document}